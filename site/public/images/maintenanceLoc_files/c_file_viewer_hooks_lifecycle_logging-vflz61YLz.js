!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="80a4c80f-91db-3730-b731-00aafe48de26")}catch(e){}}();
define(["exports","react","./e_file_viewer_static_scl_page_folder","./c_core_data_actions","./c_core_utils_uuid","./c_core_logging_actions","./c_react-redux_hooks_useDispatch"],(function(e,i,t,n,o,r,s){"use strict";function d(e){return e&&e.__esModule?e:{default:e}}var l=d(i);function a(e){const{file_viewer_session_id:i=o.v4(),file_preview_session_id:n=o.v4(),file_id:r="",sj_id:s,ns_id:d,file_extension:l=t.getWhitelistedFileExtension(""),device_type:a=t.DeviceType.desktop,extra:c={},file_preview_size:v}=e||{};return{file_viewer_session_id:i,file_preview_session_id:n,file_id:r,sj_id:s,ns_id:d,file_extension:l,device_type:a,file_preview_size:v,extra:{...c,source_context:c.source_context||t.SourceContext.FileViewer,was_flipped:c.was_flipped||!1,file_preview_timeline:{}}}}let c={};const v=e=>void 0!==e?c[e]:void 0;function u(e){return Object.keys(e).reduce(((i,t)=>{const n=e[t];return"string"==typeof n||"number"==typeof n?i[t]=String(n):"boolean"==typeof n?i[t]=String(+n):"object"==typeof n&&n&&(i[t]=JSON.stringify(n)),i}),{})}function _(e,i){return{...e,file_extension:t.getWhitelistedFileExtension(e.file_extension||""),extra:u({...e.extra,...i})}}const p=(e,i,t)=>{const{videoFormat:n,videoDuration:o,videoTruncated:r,extra:s}=e;return{file_viewer_session_id:i.file_viewer_session_id,file_preview_session_id:i.file_preview_session_id,video_format:n,video_duration_seconds:o,video_truncated:r,source_context:i.source_context,device_type:i.device_type,preview_type:t,file_id:i.file_id,extra:s}},f=new Set,w=(e,i,t)=>{const{payload:n}=t,{event:o,fileViewerId:r}=n,s=i.loggingSessionId[r],d=v(s);return d?(e.log(o,_({...d,extra:{source_context:d.extra.source_context,preview_type:d.extra.preview_type,...n.extra}})),t):(f.add(t),t)},g=e=>{const i=v(e);if(!i)return;const{file_preview_session_id:t,file_viewer_session_id:n,ns_id:o,sj_id:r,device_type:s,file_id:d,extra:{preview_type:l,source_context:a}}=null!=i?i:{extra:{}};return t&&n&&l&&a&&s?{file_preview_session_id:t,file_viewer_session_id:n,ns_id:o,sj_id:r,device_type:s,preview_type:l,source_context:a,file_id:d}:void 0};const y=()=>{const{logger:e}=t.useFileViewerContext();return t.useStabilizedCallback(((i,n,o)=>{const r=v(i);if(!r)return;const s=function(e,i){const{extra:{last_event:n}}=e;if(n!==i){switch(i){case t.SessionEventType.FilePreviewSupportConfirmed:case t.SessionEventType.FilePreviewSupportDenied:if(n!==t.SessionEventType.FilePreviewAttemptStarted)return;break;case t.SessionEventType.FilePreviewDownloadAttempted:if(n!==t.SessionEventType.FilePreviewSupportConfirmed)return;break;case t.SessionEventType.FilePreviewDownloadFailed:case t.SessionEventType.FilePreviewDownloadSucceeded:if(n!==t.SessionEventType.FilePreviewDownloadAttempted)return;break;case t.SessionEventType.FilePreviewRenderSucceeded:case t.SessionEventType.FilePreviewRenderFailed:if(n!==t.SessionEventType.FilePreviewDownloadSucceeded)return}return{...e,extra:{...e.extra,file_preview_timeline:{...e.extra.file_preview_timeline,[i]:Date.now()}}}}}(r,n);if(s)null==e||e.log(n,_(s,o),o),((e,i)=>{c={...c,[e]:i}})(i,function(e,i){return{...e,extra:{...e.extra,last_event:i}}}(s,n));else{const i={...o,current_event:n};null==e||e.log(t.BackgroundEvent.InvalidLoggingOrder,_(r,i))}}))},x=(e,i,t,n)=>{const o=y();l.default.useMemo((()=>{e&&i&&o(e,i)}),[i,o,e]),l.default.useMemo((()=>{e&&n&&o(e,t)}),[n,o,e,t])};e.analyticsMiddleware=function(e){return({getState:i,dispatch:o})=>s=>d=>{var l,a;if(f.size>0&&"object"==typeof d.payload&&"fileViewerId"in d.payload){const t=i().loggingSessionId[d.payload.fileViewerId];v(t)&&(f.forEach((t=>s(w(e,i(),t)))),f.clear())}try{switch(d.type){case r.Action.Log:return s(w(e,i(),d));case r.Action.LogVideoEvent:return((e,i)=>{var n;const{payload:o}=i,{eventName:r,filePreviewSessionId:s}=o,d=g(s);if(!d)return;const l=d.preview_type;if(l!==t.PreviewType.Video&&l!==t.PreviewType.Audio)throw new t.FVError(t.FVErrorCode.InvalidLoggingSession,t.ErrorLifecycle.Unknown,"Can't log video events for non-audio/video previews.");null===(n=e.logVideoEvent)||void 0===n||n.call(e,r,p(o,d,l))})(e,d),s(d);case r.Action.LogVideoEventQuantity:return((e,i)=>{var n;const{payload:o}=i,{eventName:r,filePreviewSessionId:s}=o,d=g(s);if(!d)return;const l=d.preview_type;if(l!==t.PreviewType.Video&&l!==t.PreviewType.Audio)throw new t.FVError(t.FVErrorCode.InvalidLoggingSession,t.ErrorLifecycle.Unknown,"Can't log video events for non-audio/video previews.");null===(n=e.logVideoEventQuantity)||void 0===n||n.call(e,r,o.quantity,p(o,d,l))})(e,d),s(d);case r.Action.LogVideoEventDuration:return((e,i)=>{var n;const{payload:o}=i,{eventName:r,filePreviewSessionId:s}=o,d=g(s);if(!d)return;const l=d.preview_type;if(l!==t.PreviewType.Video&&l!==t.PreviewType.Audio)throw new t.FVError(t.FVErrorCode.InvalidLoggingSession,t.ErrorLifecycle.Unknown,"Can't log video events for non-audio/video previews.");null===(n=e.logVideoEventDuration)||void 0===n||n.call(e,r,o.durationInMs,p(o,d,l))})(e,d),s(d);case r.Action.LogUserAction:return s(((e,i,n)=>{const{payload:o}=n,{userAction:r,actionContext:s,fileViewerId:d}=o,l=i.loggingSessionId[d],a=v(l);return a&&e.log(t.EventType.UserAction,_({...a,extra:{...(null==a?void 0:a.extra.source_context)&&{source_context:a.extra.source_context},...o.extra,action:r,context:s}})),n})(e,i(),d));case r.Action.LogBackgroundEvent:return s(((e,i,n)=>{const{payload:o}=n,{event:r,fileViewerId:s}=o,d=i.loggingSessionId[s],l=v(d);return l&&e.log(t.EventType.Background,_({...l,extra:{...(null==l?void 0:l.extra.source_context)&&{source_context:l.extra.source_context},...o.extra,event:r}})),n})(e,i(),d));case n.Action.UpdateArchiveFileCurrentPath:return s(((e,i,n)=>{const{fileViewerId:o,currentPath:r,isDir:s}=n.payload,d=i.loggingSessionId[o],l=v(d);if(void 0!==s&&l){const i=_({...l,extra:u({action:t.UserAction.ArchiveNavigation,context:t.UserActionContext.PreviewContentMain,isDir:String(s),extension:s?"":t.getWhitelistedFileExtension(t.getFileExtension(r[r.length-1]))})});e.log(t.EventType.UserAction,i)}return n})(e,i(),d));case r.Action.LogDuration:return s(((e,i,t)=>{var n;const{eventName:o,duration:r,fileViewerId:s,tags:d,shouldLogToHive:l}=t.payload,a=i.loggingSessionId[s],c=v(a);return c&&(null===(n=e.logDuration)||void 0===n||n.call(e,{eventName:o,durationInMs:r,session:c?_(c):void 0,tags:d,shouldLogToHive:l})),t})(e,i(),d))}}catch(e){if(e instanceof Error){const r=("object"==typeof d.payload&&"fileViewerId"in d.payload?null===(l=v(i().loggingSessionId[d.payload.fileViewerId]))||void 0===l?void 0:l.extra.preview_type:"other")||"other";o(n.reportException({error:e,fileType:r,severity:(a=e,t.isFVError(a)&&a.type===t.FVErrorCode.InvalidLoggingSession?"user-error":"critical")})),console.warn(e.message)}}return s(d)}},e.getLoggingSession=v,e.serializeSession=_,e.useDownloadSucceeded=(e,i)=>{x(e,t.SessionEventType.FilePreviewDownloadAttempted,t.SessionEventType.FilePreviewDownloadSucceeded,i)},e.useEndSession=e=>{const i=y(),n=s.useDispatch();l.default.useEffect((()=>{if(!e)return;const n=()=>{var n;const o=null===(n=v(e))||void 0===n?void 0:n.extra.last_event;i(e,t.SessionEventType.FilePreviewSessionEnded,{...o&&{last_event:o}}),t.PreviewsEventLogger.endCurrentSession()};return window.addEventListener("beforeunload",n),()=>{n(),window.removeEventListener("beforeunload",n)}}),[n,i,e])},e.useInitializePreviewSession=(e,i,r,d)=>{const v=s.useDispatch(),{deviceType:u,fileViewerId:_,featureConfig:p,sourceSession:f}=t.useFileViewerContext();l.default.useRef(p).current=p;const w=l.default.useRef(f);w.current=f;const g=l.default.useRef(i);g.current=i;const y=l.default.useRef(r);y.current=r;const[x,S]=l.default.useMemo((()=>{const i=o.v4();if(!e)return[void 0,void 0];const n=y.current,r=g.current,s=t.isNestedArchiveFilePreviewKey(e),l=t.getFileExtension(s?e.subpath:n.file_name),v=s?{source_context:t.SourceContext.ArchiveFile,page_start_ts:Date.now(),was_flipped:!1}:w.current,p=t.resolvePreviewTypeFromExtension(l);var f,x;return f=i,x={file_viewer_session_id:_,file_preview_session_id:i,file_id:r.file_id,sj_id:r.sj_id,ns_id:r.ns_id,device_type:u,file_extension:t.getWhitelistedFileExtension(l),file_preview_size:n.size,extra:{...v,preview_type:p}},c={...c,[f]:a(x)},null==d||d(i),[i,{fileViewerId:_,previewKey:e,fileExtension:l,previewType:p,filePreviewSessionId:i}]}),[u,_,d,e]);return l.default.useEffect((()=>{S&&v(n.initializeFilePreviewSession(S))}),[v,S]),x},e.useLogSessionEvent=y,e.useRenderSucceededWithLogging=(e,i)=>{const[n,o]=l.default.useState(!1);return x(e,void 0,t.SessionEventType.FilePreviewRenderSucceeded,n),l.default.useCallback((()=>{o(!0),i()}),[i])},e.useSupportConfirmed=(e,i)=>{x(e,t.SessionEventType.FilePreviewAttemptStarted,t.SessionEventType.FilePreviewSupportConfirmed,i)}}));
//# sourceMappingURL=c_file_viewer_hooks_lifecycle_logging.js-vflSRDGLB.map

//# debugId=80a4c80f-91db-3730-b731-00aafe48de26