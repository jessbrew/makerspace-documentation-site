!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="831d90a0-457b-385d-9a3c-43cfa026a26c")}catch(e){}}();
define(["exports","./e_file_viewer_static_scl_page_folder","./c_contacts_contact","./c_profile_services_profile_services_link","./c_api_v2_routes_password_confirmation_provider","./c_pap-events_navigation_select_create_folder_action","./c_lodash","./e_data_modules_stormcrow","./e_edison","./c_api_v2_routes_folders_info_provider","./e_core_exception"],(function(t,e,s,i,r,n,c,o,a,h,l){"use strict";var u;const _=t=>t,d=t=>"string"==typeof t?t:JSON.stringify(t),f=()=>{},p=t=>t?t.split(/\s+/):[],m=t=>t?t.split(/\W+/):[],g=t=>function(e){return s=>{let i=[];return e.forEach((e=>{var r;i=i.concat(t(null!==(r=s[e])&&void 0!==r?r:""))})),i}},C={nonword:m,whitespace:p,obj:{nonword:g(m),whitespace:g(p)}};class w{constructor(){this.add=t=>{this.head&&(t.next=this.head,this.head.prev=t),this.head=t,this.tail=this.tail||t},this.remove=t=>{t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev},this.moveToFront=t=>{this.remove(t),this.add(t)},this.head=this.tail=void 0}}class y{constructor(t,e){this.key=t,this.val=e,this.prev=this.next=void 0}}class b{constructor(t){this.set=(t,e)=>{const s=this.list.tail;this.size>=this.maxSize&&s&&(this.list.remove(s),delete this.hash[s.key],this.size--);const i=this.hash[t];if(i)i.val=e,this.list.moveToFront(i);else{const s=new y(t,e);this.list.add(s),this.hash[t]=s,this.size++}},this.get=t=>{const e=this.hash[t];if(e)return this.list.moveToFront(e),e.val},this.reset=()=>{this.size=0,this.hash={},this.list=new w},this.maxSize=null!=t?t:100,this.reset(),this.maxSize<=0&&(this.set=f,this.get=f)}}const v=window.localStorage,T=()=>(new Date).getTime();class E{constructor(t){this.getPrefix=t=>this.prefix+t,this.getTtlKey=t=>this.getPrefix(t)+this.ttlKey,this.safeSet=(t,e)=>{try{v.setItem(t,e)}catch(t){t instanceof Error&&"QuotaExceededError"===t.name&&this.clear()}},this.get=t=>{var e;return this.isExpired(t)&&this.remove(t),JSON.parse(null!==(e=v.getItem(this.getPrefix(t)))&&void 0!==e?e:"")},this.set=(t,e,s)=>(s?this.safeSet(this.getTtlKey(t),(T()+s).toString()):v.removeItem(this.getTtlKey(t)),this.safeSet(this.getPrefix(t),JSON.stringify(e))),this.remove=t=>(v.removeItem(this.getTtlKey(t)),v.removeItem(this.getPrefix(t)),this),this.clear=()=>{const t=(t=>{var e;let s,i;const r=[],n=v.length;for(s=0;s<n;s++)(null===(e=i=v.key(s))||void 0===e?void 0:e.match(t))&&r.push(i.replace(t,""));return r})(this.keyMatcher);for(let e=t.length;e--;)this.remove(t[e]);return this},this.isExpired=t=>{var e;const s=JSON.parse(null!==(e=v.getItem(this.getTtlKey(t)))&&void 0!==e?e:"");return"number"==typeof s&&T()>s},this.prefix=["__",t,"__"].join(""),this.ttlKey="__ttl__",this.keyMatcher=new RegExp("^"+this.prefix.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"))}}class k{constructor(t){this.fingerprint=t=>{var e;return t.url+JSON.stringify(null!==(e=t.fingerprint)&&void 0!==e?e:{})},this.makeRequest=(t,e)=>{const s=new URL(t.url,"https://www.dropbox.com"),i=fetch(s,t).then((t=>(k.pendingRequestsCount--,delete k.pendingRequests[e],t.json())));return k.pendingRequestsCount++,k.pendingRequests[e]=i,i},this._get=async t=>{const e=this.fingerprint(t);if(this.cancelled||e!==this.lastReq)return;const s=k.pendingRequests[e];if(!s&&k.pendingRequestsCount>=k.maxPendingRequests)return;const i=s||this.makeRequest(t,e);let r;try{r=await i,this.cache.set(e,r)}catch(t){r=void 0}return r},this.get=async t=>{const e="string"==typeof t?{url:t}:t,s=this.fingerprint(e);this.cancelled=!1,this.lastReq=s;const i=this.cache.get(s);return i||await this._get(e)},this.cancel=()=>{this.cancelled=!0},this.cancelled=!1,this.lastReq=void 0,this.cache=!1===t.cache?new b(0):k.sharedCache}}u=k,k.pendingRequests={},k.sharedCache=new b(10),k.pendingRequestsCount=0,k.maxPendingRequests=6,k.setMaxPendingRequests=t=>{u.maxPendingRequests=t},k.resetCache=()=>{u.sharedCache.reset()};const S="c",x=t=>t.filter((t=>!!t)).map((t=>t.toLowerCase())),L=()=>({i:[],[S]:{}});class R{constructor(t){this.bootstrap=t=>{this.datums=t.datums,this.trie=t.trie},this.add=t=>{t.forEach((t=>{const e=this.identify(t);this.datums[e]=t;x(this.datumTokenizer(t)).forEach((t=>{let s,i=this.trie;const r=t.split("");for(;s=r.shift();)i=i[S][s]||(i[S][s]=L()),i.i.push(e)}))}))},this.get=t=>t.map((t=>this.datums[t])),this.search=t=>{let e;return x(this.queryTokenizer(t)).forEach((t=>{let s,i,r;if(e&&0===e.length)return!1;s=this.trie;const n=t.split("");for(;s&&(i=n.shift());)s=s[S][i];return s&&0===n.length?(r=s.i.slice(0),e=e?((t,e)=>{let s=0,i=0;const r=[];t=t.sort(),e=e.sort();const n=t.length,c=e.length;for(;s<n&&i<c;)t[s]<e[i]?s++:(t[s]>e[i]||(r.push(t[s]),s++),i++);return r})(e,r):r):e=[],!1})),e?(t=>{const e={},s=[];for(let i=0,r=t.length;i<r;i++)e[t[i]]||(e[t[i]]=!0,s.push(t[i]));return s})(e).map((t=>this.datums[t])).filter((t=>!!t)):[]},this.all=()=>{const t=[];for(const e in this.datums)if(this.datums.hasOwnProperty(e)){const s=this.datums[e];s&&t.push(s)}return t},this.reset=()=>{this.datums={},this.trie=L()},this.serialize=()=>({datums:this.datums,trie:this.trie}),this.identify=t.identify||d,this.datumTokenizer=t.datumTokenizer,this.queryTokenizer=t.queryTokenizer,this.reset()}}const A="data",q="protocol",O="thumbprint";class D{constructor(t){this.settings=()=>({url:this.url,method:"GET"}),this.store=t=>{this.cache&&(this.storage.set(A,t,this.ttl),this.storage.set(q,location.protocol,this.ttl),this.storage.set(O,this.thumbprint,this.ttl))},this.fromCache=()=>{if(!this.cache)return;const t=this.storage.get(A),e=this.storage.get(q),s=this.storage.get(O)!==this.thumbprint||e!==location.protocol;return t&&!s?t:void 0},this.fromNetwork=async()=>{const t=this.prepare(this.settings());try{const e=await fetch(t.url,t);return await e.json()}catch(t){return}},this.clear=()=>(this.storage.clear(),this),this.url=t.url,this.ttl=t.ttl,this.cache=t.cache,this.prepare=t.prepare,this.thumbprint=t.thumbprint,this.storage=new E(t.cacheKey)}}class U{constructor(t){this.settings=()=>({url:this.url,method:"GET"}),this.get=async t=>{t=t||"";const e=this.prepare(t,this.settings());return await this.transport.get(e)},this.cancelLastRequest=()=>{this.transport.cancel()},this.url=t.url,this.prepare=t.prepare,this.transport=new k({cache:t.cache})}}const I=t=>{var e;if(!t)return;const s="string"==typeof t?{url:t}:t;return{url:s.url,ttl:864e5,cache:!0,prepare:null!==(e=s.prepare)&&void 0!==e?e:_,cacheKey:s.cacheKey||s.url,thumbprint:"0.11.1"+s.thumbprint}},F=t=>{var e;if(!t)return;const s="string"==typeof t?{url:t}:t;return{url:s.url,cache:null===(e=s.cache)||void 0===e||e,prepare:N(s)}},N=t=>{const{prepare:e,replace:s,wildcard:i}=t;return e||(s?(t,e)=>(e.url=s(e.url,t),e):i?(t,e)=>(e.url=e.url.replace(i,encodeURIComponent(t)),e):(t,e)=>e)};class M{constructor(t){this.loadPrefetch=async()=>{var t;if(!this.prefetch)return;const e=this.prefetch.fromCache();if(e)return void this.index.bootstrap(e);const s=await this.prefetch.fromNetwork();s&&this.add(s),null===(t=this.prefetch)||void 0===t||t.store(this.index.serialize())},this._initialize=async()=>{this.clear(),await this.loadPrefetch(),this.add(this.local)},this.initialize=t=>!this.initPromise||t?this._initialize():this.initPromise,this.add=t=>(this.index.add(t),this),this.get=t=>this.index.get(t),this.search=async(t,e,s)=>{const i=this.sorter(this.index.search(t));if(e(this.remote?i.slice():i),this.remote&&i.length<this.sufficient){const e=await this.remote.get(t),r=[];null==e||e.forEach((t=>{i.some((e=>this.identify(t)===this.identify(e)))||r.push(t)})),null==s||s(r)}else this.remote&&this.remote.cancelLastRequest()},this.all=()=>this.index.all(),this.clear=()=>(this.index.reset(),this),this.clearPrefetchCache=()=>{var t;return null===(t=this.prefetch)||void 0===t||t.clear(),this},this.clearRemoteCache=()=>(k.resetCache(),this);const e=(t=>{var e,s,i;return{initialize:!0,identify:null!==(e=t.identify)&&void 0!==e?e:d,datumTokenizer:t.datumTokenizer,queryTokenizer:t.queryTokenizer,sufficient:null!==(s=t.sufficient)&&void 0!==s?s:5,local:"function"==typeof t.local?t.local():null!==(i=t.local)&&void 0!==i?i:[],prefetch:I(t.prefetch),remote:F(t.remote),sorter:t.sorter?e=>e.sort(t.sorter):_}})(t);this.sorter=e.sorter,this.identify=e.identify,this.sufficient=e.sufficient,this.local=e.local,this.remote=e.remote?new U(e.remote):void 0,this.prefetch=e.prefetch?new D(e.prefetch):void 0,this.index=new R({identify:this.identify,datumTokenizer:e.datumTokenizer,queryTokenizer:e.queryTokenizer}),this.initialize()}}M.tokenizers=C;const z={},B={getOrCreateForUser(t,n){if(t.id in z)return z[t.id];let c;if(n.remoteEndpoint){const e=String(t.id);c={url:V(n.remoteEndpoint),prepare:(t,s)=>{var i;const n=new FormData;return n.append("query",JSON.stringify(t)),n.append("_subject_uid",e),{...s,method:"POST",headers:{"X-CSRF-Token":null!==(i=r.readCsrfToken())&&void 0!==i?i:"","X-Dropbox-Uid":e},body:n,fingerprint:`${t}:${e}`}}}}const o=new M({datumTokenizer:s.ContactCommon.get_index_tokens,queryTokenizer:M.tokenizers.whitespace,identify:s.ContactCommon.get_key,sufficient:n.sufficientResults,sorter:s.ContactCommon.sorter,local:[],remote:c});z[t.id]=o;const a=e.DeprecatedViewer.get_viewer();if(a.is_user_signed_in(t)){const e=n.localCacheStore.getOrCreateForUser(a,t);e.load_contacts(!1,(s=>{P(t,s),e.register_for_updates("bloodhound_contacts_v2",(e=>{P(t,e)}))}))}return i.LinkedProfileServices.get_linked_profile_services_for_user(t.id).register_for_service_changes("bloodhound_contacts_v2",(()=>{o.clearRemoteCache()})),z[t.id]},search:(t,s,i,r,n)=>{const c=B.getOrCreateForUser(t,s);if(!i)return r([]),void(n&&s.remoteEndpoint&&n([]));const o=e.DeprecatedViewer.get_viewer(),a=s.localCacheStore.getOrCreateForUser(o,t);a.is_loaded()?c.search(i,r,n):a.load_contacts(!1,(t=>{c.search(i,r,n)})),a.refresh_contacts(!1)},getAll:(t,e)=>B.getOrCreateForUser(t,e).all(),clearCache(t){delete z[t.id]}};function P(t,e){!function(t,e){if(!(t.id in z))return;const i=z[t.id];e=e.filter(s.ContactCommon.is_valid),i.clearRemoteCache(),i.clear(),i.add(e)}(t,e.includeForUser(t.id).contacts)}function V(t){const e=".dropbox.com",s=document.createElement("a");s.href=t;const i=s.hostname||window.location.hostname;if(-1===i.indexOf(e,i.length-12))throw new Error("Cannot send the CSRF token to "+i);return t}var Q;!function(t){t[t.ALL=0]="ALL",t[t.INDIVIDUAL=1]="INDIVIDUAL"}(Q||(Q={}));const j={ALL:{getUrl:"/contacts/get",refreshUrl:"/contacts/refresh",boltAppId:"contacts_cache_notify"},INDIVIDUAL:{getUrl:"/contacts/get_individual_for_user",refreshUrl:"/contacts/refresh_individual_for_user",boltAppId:"individual_contacts_cache_notify"}};class K{static create_contacts_list(t){return new K(t,null)}static create_per_user_contacts_list(t,e){return new K(t,e)}constructor(t,e){this.filterContacts=this.filterContacts.bind(this),this.length=this.length.bind(this),this.slice=this.slice.bind(this),this.includeForUser=this.includeForUser.bind(this),this.includeForViewer=this.includeForViewer.bind(this),this.excludeByEmail=this.excludeByEmail.bind(this),this.excludeMe=this.excludeMe.bind(this),this.excludeNewStyleGroups=this.excludeNewStyleGroups.bind(this),this.excludeFacebook=this.excludeFacebook.bind(this),this.excludeTeamMembers=this.excludeTeamMembers.bind(this),this.excludePairedUserDuplicates=this.excludePairedUserDuplicates.bind(this),this.excludeNonTeam=this.excludeNonTeam.bind(this),this.excludeNonTeamActive=this.excludeNonTeamActive.bind(this),this.excludeSuspended=this.excludeSuspended.bind(this),this.sortByTeamFirst=this.sortByTeamFirst.bind(this),this._excludeType=this._excludeType.bind(this),this._lowercaseContact=this._lowercaseContact.bind(this),this.contacts=t,this.owningUserId=e,this.lcontacts=Array.from(this.contacts).map((t=>this._lowercaseContact(t)))}filterContacts(t){const e=this.contacts.filter(t);return new K(e,this.owningUserId)}length(){return this.contacts.length}slice(t,e){return new K(this.contacts.slice(t,e),this.owningUserId)}includeForUser(t){if(null!=this.owningUserId)return this.owningUserId===t?this:new K([],t);{const e=this.contacts.filter((e=>e.owning_user_id===t));return new K(e,t)}}includeForViewer(t){const e=t.get_user_ids();return this.filterContacts((t=>Array.from(e).includes(t.owning_user_id)))}excludeByEmail(t){return t=t?t.toLowerCase():"",this.filterContacts((e=>!(t===e.email.toLowerCase())))}excludeMe(){return this.filterContacts((t=>!t.is_owner))}excludeNewStyleGroups(){return this._excludeType(e.ContactTypes.NEW_STYLE_GROUP)}excludeFacebook(){return this._excludeType(e.ContactTypes.FB)}excludeTeamMembers(){return this.filterContacts((t=>!t.team))}excludePairedUserDuplicates(){return this.filterContacts((t=>!t.paired_user_duplicate))}excludeNonTeam(){return this.filterContacts((t=>t.team))}excludeNonTeamActive(){return this.filterContacts((t=>t.team&&"active"===t.join_state))}excludeSuspended(){return this.filterContacts((t=>"suspended"!==t.join_state))}sortByTeamFirst(){return new K(K.sortContactsByTeamFirst(this.contacts),this.owningUserId)}static sortContactsByTeamFirst(t){const e=[],s=[];for(const i of Array.from(t))i.team?e.push(i):s.push(i);return e.concat(s)}_excludeType(t){return this.filterContacts((e=>e.type!==t))}_lowercaseContact(t){const e={};for(const s in t){let i=t[s];("string"==typeof i||i instanceof String)&&(i=i.toLowerCase()),e[s]=i}return e}}class J{static initClass(){this.MAX_REQUEST_PERF_RECORDS=20}constructor(t){this.callbacks={},this.one_time_callbacks=[],this.cached_contacts=null,this._cache_download_name=t,this.should_force_refresh=!1,this.request_perf_records=[],this._config=null}register_for_updates(t,e){this.callbacks[t]=e}unregister_for_updates(t){null!=this.callbacks[t]&&delete this.callbacks[t]}get_contacts_count(){return null!=this.cached_contacts?this.cached_contacts.length():0}get_downloaded_time(){const t=window.performance.getEntriesByName(this._get_contacts_downloaded_mark_name());return t&&t.length?t[0].startTime:null}get_request_perf_records(){return this.request_perf_records}_is_contact_get_or_check_ajax_request(t){const{initiatorType:e}=t,{name:s}=t;return"xmlhttprequest"===e&&s.endsWith(this._config.getUrl)}_find_last_perf_entry(t=500){const e=window.performance.getEntriesByType("resource");if(e.length){for(let s=Math.min(e.length-1,t);s>=0;s--)if(this._is_contact_get_or_check_ajax_request(e[s]))return e[s]}return null}_record_perf_stats(t={}){const e=this._find_last_perf_entry();if(e&&(t.ttfb=e.responseStart-e.requestStart,t.downloading_time=e.responseEnd-e.responseStart,t.duration=e.duration,this.request_perf_records.push(t),this.request_perf_records.length>J.MAX_REQUEST_PERF_RECORDS))return this.request_perf_records=this.request_perf_records.slice(this.request_perf_records.length-1)}_get_request_url(){throw new Error("method unimplemented")}_get_request_params(){throw new Error("method unimplemented")}_contacts_loaded_callback(t){throw new Error("method unimplemented")}_fetch_contacts(t){return e.BackgroundRequest({url:this._get_request_url(),data:this._get_request_params(),...t?{subject_user:t}:{},success:(t,e,s)=>{const i=JSON.parse(t);if(this._contacts_loaded_callback(i),this._schedule_fetch)return this._schedule_fetch()}})}_get_versioned_params(t,e=!0){const s={version:t};return e&&(s.force_refresh=this.should_force_refresh,this.should_force_refresh=!1),null!=this.digest&&(s.digest=this.digest),null!=this.limit&&(s.limit=this.limit),s}_get_contacts_downloaded_mark_name(){return`${this._cache_download_name}-${this.instance}`}_is_page_hidden(){return null!=window.document.visibilityState&&window.document.hidden}_add_one_time_callback(t){if(null!=t&&!Array.from(this.one_time_callbacks).includes(t))return this.one_time_callbacks.push(t)}_invoke_all_callbacks(t){return this._invoke_callbacks(this.one_time_callbacks,t,!0),this._invoke_callbacks(this.callbacks,t,!1)}_invoke_one_time_callbacks(t){return this._invoke_callbacks(this.one_time_callbacks,t,!0)}_invoke_callbacks(t,e,s){return(()=>{const i=[];for(const r of Array.from(Object.keys(t)))t[r](e),s?i.push(delete t[r]):i.push(void 0);return i})()}}J.initClass();class H extends J{static initClass(){this.INSTANCE=0,this.BOLT_NEED_TO_SEND_REQUEST=0,this.BOLT_REQUEST_SENT=1,this.REFRESH_THRESHOLD=36e5}constructor(t,e=null,s=null){super("BoltContactsCache download"),this.bolt_update_callback=this.bolt_update_callback.bind(this),this.bolt_refresh_callback=this.bolt_refresh_callback.bind(this),this.cache_type=t,this.limit=e,this.user_id=s,this.instance=H.INSTANCE++,this.loading_state=H.BOLT_NEED_TO_SEND_REQUEST,this._config=j[Q[this.cache_type]],this.current_bolt_states=null,this._notified_states={},this._bolt=null,this._last_refresh_ts=null}load_contacts(t,e){r.isAnyUserSignedIn()&&(this._add_one_time_callback(e),(this.loading_state===H.BOLT_NEED_TO_SEND_REQUEST||t)&&(this.loading_state=H.BOLT_REQUEST_SENT,t&&(this.should_force_refresh=!0),this._fetch_contacts(this._getUserId())),!this._should_update_contacts()&&this.is_loaded()&&this._invoke_one_time_callbacks(this.cached_contacts))}refresh_contacts(t=!1){const s=window.performance.now();if(this._last_refresh_ts||(t=!0),!t&&this._last_refresh_ts&&s-this._last_refresh_ts<H.REFRESH_THRESHOLD)return;const i=this._getUserId();return e.BackgroundRequest({url:this._get_refresh_url(),data:this._get_refresh_params({force_refresh:t}),...i?{subject_user:i}:{}}),this._last_refresh_ts=s}is_loaded(){return null!=this.cached_contacts}bolt_update_callback(t){for(const e of Array.from(t))(!Array.from(this._notified_states).includes(e.unique_id)||+this._notified_states[e.unique_id].revision<+e.revision)&&(this._notified_states[e.unique_id]=e);return this._should_update_contacts()&&(this.loading_state=H.BOLT_NEED_TO_SEND_REQUEST),this.load_contacts()}bolt_refresh_callback(t){if(null!=this._bolt&&this._bolt.unsubscribe(),this._bolt=null,this.loading_state=H.BOLT_NEED_TO_SEND_REQUEST,!this._is_page_hidden())return this.load_contacts()}_contacts_loaded_callback(t){if(this._is_old_contacts(t.bolt_info))return;const e=this._is_new_contacts(t.bolt_info);return this.current_bolt_states=t.bolt_info,null==this._bolt&&this._subscribe_to_bolt(),e&&(null!=t.contacts?t.contacts.length:void 0)?(this._record_perf_stats({num_contacts:t.contacts.length}),this.digest=t.digest,this._create_contacts_list(t.contacts),this._invoke_all_callbacks(this.cached_contacts),window.performance.mark(this._get_contacts_downloaded_mark_name())):void 0}_create_contacts_list(t){return this.cached_contacts=K.create_contacts_list(t)}_subscribe_to_bolt(){const t=[];for(const s in this.current_bolt_states){const i=this.current_bolt_states[s];t.push(new e.SignedChannelState(this._config.boltAppId,s.toString(),i.revision,i.token))}return this._bolt=new e.MetaserverBoltClient(t,this.bolt_update_callback,this.bolt_refresh_callback),this._bolt.start()}_is_new_contacts(t){return this._first_contacts_are_newer(t,this.current_bolt_states)}_is_old_contacts(t){return this._first_contacts_are_newer(this.current_bolt_states,t)}_first_contacts_are_newer(t,e){if(!e)return!0;for(const s in e){const i=e[s];for(const e in t){const r=t[e];if(e===s&&+i.revision<+r.revision)return!0}}return!1}_should_update_contacts(){return this._is_new_contacts(this._notified_states)}_get_request_params(){return this._get_versioned_params(1)}_get_request_url(){return this._config.getUrl}_get_refresh_params(t={}){return t}_get_refresh_url(){return this._config.refreshUrl}_getUserId(){var t;const e=null!==(t=this.user_id)&&void 0!==t?t:r.getActiveUserId();return void 0===e&&l.reportStack("Contacts API request from BoltContactsCache without subject user",{tags:["contacts-uid-aware-migration"]}),e}}H.initClass();class G extends H{constructor(t,e){h.assert(null!=e.id,"user has invalid id"),super(t,null,e.id),this.cache_type=t,this.user=e}_create_contacts_list(t){return this.cached_contacts=K.create_per_user_contacts_list(t,this.user.id)}}class W{constructor(t){this.cacheType=t}}const $=new class extends W{getOrCreateForUser(t,e){if(!t.is_uid_associated(e.id))throw new Error("Requested contacts cache for a user not associated with the current viewer.");return this.getOrCreateForViewer()}getOrCreateForViewer(){return null==this.contactsCache&&(this.contactsCache=new H(this.cacheType)),this.contactsCache}}(Q.ALL),X=new class extends W{constructor(){super(...arguments),this.uidToContactsCache={}}getOrCreateForUser(t,e){return e.id in this.uidToContactsCache||(this.uidToContactsCache[e.id]=new G(this.cacheType,e)),this.uidToContactsCache[e.id]}}(Q.INDIVIDUAL);class Y extends r.Message{constructor(t){super(),this.mergeSearchAllowed={},r.proto3.util.initPartial(t,this)}static fromBinary(t,e){return(new Y).fromBinary(t,e)}static fromJson(t,e){return(new Y).fromJson(t,e)}static fromJsonString(t,e){return(new Y).fromJsonString(t,e)}static equals(t,e){return r.proto3.util.equals(Y,t,e)}}Y.runtime=r.proto3,Y.typeName="js_init_data.contacts.ContactsConstants",Y.fields=r.proto3.util.newFieldList((()=>[{no:1,name:"merge_search_allowed",kind:"map",K:3,V:{kind:"scalar",T:8}}]));const Z={typeName:"contacts.ContactsConstantsPrefetchService",methods:{fetchConstants:{name:"FetchConstants",I:a.PrefetchArgs,O:Y,kind:h.MethodKind.Unary}}};const tt="contacts:const_prefetch",et=["Concurrency limit exceeded","Failed to fetch"],st=o.createGenericQuery({queryRouteFilter:["custom",tt],queryFn:({})=>async({})=>{try{return{apiData:await async function(){return await a.Edison.fetch(Z,"FetchConstants")}(),pkgData:null}}catch(t){const e=t.message;if(et.some((t=>null==e?void 0:e.includes(t))))return{apiData:{mergeSearchAllowed:{}},pkgData:null};throw t}},getQueryKey:o.getGenericQueryKey("custom",tt)});var it;t.ContactsSearchMode=void 0,(it=t.ContactsSearchMode||(t.ContactsSearchMode={}))[it.ALL_LOCAL=0]="ALL_LOCAL",it[it.INDIVIDUAL_LOCAL_TEAM_REMOTE=1]="INDIVIDUAL_LOCAL_TEAM_REMOTE",t.ContactsSearchMode.ALL_LOCAL;const rt={ALL_LOCAL:{localCacheStore:$,sufficientResults:1e3,remoteDebounceWait:10},INDIVIDUAL_LOCAL_TEAM_REMOTE:{localCacheStore:X,remoteEndpoint:"/team/search_contacts",remoteBatchEndpoint:"/team/search_contacts_batch",sufficientResults:1e3,remoteDebounceWait:10}};const nt=t=>c.debounce(t,10,{leading:!0,trailing:!0});class ct{constructor(t,e,i,r=!0,n=!0){this.searchInternal=nt(((t,e,s)=>{if(""===(t=ct.normalizeQuery(t)))return e([]),void(s&&s([]));B.search(this.user,this.searchConfig,t,(s=>this.processMatches(s,e,t)),(e=>this.processMatches(e,s,t)))})),this.searchBatchInternal=nt(((t,e,i)=>{const r=t.map(ct.normalizeQuery).filter((t=>t.length>0)),n={};for(const t of r){const e=e=>{n[t]=this.processMatches(e,void 0,t)};B.search(this.user,this.searchConfig,t,e)}if(e(n),!this.searchConfig.remoteBatchEndpoint)return;this.searchRemoteBatch(r,(t=>{if(!i)return;const e={};for(const i in t)if(t.hasOwnProperty(i)){const r=n[i].map(s.ContactCommon.get_key),c=t[i].filter((t=>{const e=s.ContactCommon.get_key(t);return r.every((t=>t!==e))}));e[i]=this.processMatches(c)}i(e)}))})),this.query=this.search,this.query_batch=this.searchBatch,this.user=t,this.filterFunc=i,this.excludeDomainContacts=r,this.excludeDirectoryRestrictedContacts=n,this.searchConfig=e,B.getOrCreateForUser(this.user,e)}search(t,e,s){this.searchInternal(t,e,s)}searchBatch(t,s,i){const r=this.searchConfig.localCacheStore.getOrCreateForUser(e.DeprecatedViewer.get_viewer(),this.user);if(r.is_loaded())return this.searchBatchInternal(t,s,i);r.load_contacts(!0,(()=>this.searchBatchInternal(t,s,i)))}normalizeQuery(t){return t.trim().toLowerCase()}getStats(){const t=this.searchConfig.localCacheStore.getOrCreateForUser(e.DeprecatedViewer.get_viewer(),this.user);return{numLocalContacts:t.get_contacts_count(),localContactsDownloadedTime:t.get_downloaded_time()}}searchRemoteBatch(t,s){e.WebRequest({url:this.searchConfig.remoteBatchEndpoint,type:"post",subject_user:this.user.id,dataType:"json",data:{queries:JSON.stringify(t)},success:s})}isTeamContact(t){return this.user.is_team&&null!=t.team&&t.team}static isDirectoryRestrictedContact(t,e){const s=!!t.is_directory_restricted,i=e&&e===t.email;return s&&!i}processMatches(t,i,r){const c=[];for(const i of t){r&&(i.nameMatch=n.fuzzy.match(r,i.name||""),i.emailMatch=n.fuzzy.match(r,i.email||"")),i.on_team=!(i.type===e.ContactTypes.FB||!this.isTeamContact(i));const t=new s.Contact(i);t.pending=!1;const o=this.excludeDomainContacts&&t.domain_contact,a=this.excludeDirectoryRestrictedContacts&&ct.isDirectoryRestrictedContact(t,r);o||a||this.filterFunc&&!this.filterFunc(t)||c.push(t)}return i&&i(c),c}getAll(t){const i=this.searchConfig.localCacheStore.getOrCreateForUser(e.DeprecatedViewer.get_viewer(),this.user);if(i.is_loaded()){const e=B.getAll(this.user,this.searchConfig).map((t=>new s.Contact(t))),i=this.filterFunc?e.filter(this.filterFunc):e;t(i)}else i.load_contacts(!0,(e=>{if(e){const s=e.contacts,i=this.filterFunc?s.filter(this.filterFunc):s;t(i)}}))}}ct.normalizeQuery=t=>t.trim().toLocaleLowerCase();t.BloodhoundContactsV2=B,t.CONTACTS_SEARCH_PREEMPTED_THRESHOLD=300,t.ContactsDataSourceV2=ct,t.contactsConstantsPrefetchRequest=st,t.getSearchConfigForUser=async function(e){var s;const i=(await(s=o.queryClient,st.fetchQuery(s,{apiArg:null,pkgArg:null}))).apiData.mergeSearchAllowed[e]?t.ContactsSearchMode.INDIVIDUAL_LOCAL_TEAM_REMOTE:t.ContactsSearchMode.ALL_LOCAL;return rt[t.ContactsSearchMode[i]]},t.useContactsSearchConfig=function(e){const{data:s,isLoading:i}=(t=>{const{data:e,isLoading:s}=st.useQuery({apiArg:null,pkgArg:null},{useErrorBoundary:!0,enabled:!!t});return s?{isLoading:s,data:void 0}:{isLoading:s,data:e.apiData}})(e);if(!e)return{config:rt[t.ContactsSearchMode[t.ContactsSearchMode.ALL_LOCAL]],isLoading:!1};if(i)return{isLoading:i,config:void 0};const r=s.mergeSearchAllowed[e]?t.ContactsSearchMode.INDIVIDUAL_LOCAL_TEAM_REMOTE:t.ContactsSearchMode.ALL_LOCAL;return{config:rt[t.ContactsSearchMode[r]],isLoading:i}}}));
//# sourceMappingURL=c_contacts_hooks.js-vflKuadLw.map

//# debugId=831d90a0-457b-385d-9a3c-43cfa026a26c