!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="8b628ee6-251d-3e02-b8df-3ad631091fce")}catch(e){}}();
define(["exports","react","./e_file_viewer_static_scl_page_folder","./c_lodash","./c_flux_dispatcher","./e_core_exception","./e_data_modules_stormcrow","./c_core_utils_browser_detection","./c_core_utils_uuid","./c_viewer_hoc","./c_core_i18n","./c_flux_base_store","./c_api_v2_routes_folders_info_provider","./c_flux_action_type","./c_sharing_content_info","./c_cloud_docs_constants","./c_sharing_low_distraction_view_gating_utils","./c_file_viewer_common_share_helpers"],(function(e,t,s,n,i,a,r,o,c,_,l,d,u,h,E,S,p,m){"use strict";function f(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var n=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var I=f(t);s.injectInternalStyle("/static/metaserver/static/js/file_viewer/title_bar/title_bar_pass_ui.module.out-vflMh8hJr.css",(e=>"._pass_1wgu7_1{align-items:center;display:flex;height:var(--dig-spacing__macro__medium);justify-content:center;padding-bottom:2px}"));const g=5e3,C=256,A="-",T={WEB:0,IOS:1,ANDROID:2,DESKTOP:3};class N{constructor(e,t,s=void 0){this.platform=e,this.surface=t,this.identifier=null!=s?s:"";let n=!1;for(const e in T){const t=T[e];if(this.platform===t){n=!0;break}}if(!n)throw new Error("platform must be from Beacon.Platforms");if(this.surface.length>32||0===this.surface.length)throw new Error("surface must be populated and <= 32 chars.");if(this.identifier.length>128)throw new Error("identifier must be <= 128 chars.")}static from_json(e){return new N(e.platform,e.surface,e.identifier)}}class P{constructor(e,t,s,n){if(this.user_id=e,this.app=t,this.context=s,this.source=n,this.user_id.length>C)throw new Error("user_id must be <= 256 chars.");if(this.app.length>32||0===this.app.length)throw new Error("app must be populated and <= 32 chars.");if(this.context.length>64||0===this.context.length)throw new Error("context must be populated and <= 64 chars.")}static from_json(e){const t=N.from_json(e.source);return new P(e.user_id,e.app,e.context,t)}}class R{constructor(e,t,s){if(this.agent=e,this.status=t,this.auth_key=s,this.status.length>32)throw new Error("status must be <= 32 chars")}static from_json(e){return new R(P.from_json(e.agent),e.status)}}const M="UserContext",L="UserApp",F="Context";class U{constructor(e,t,s,n,i){if(this.type=e,this.user_id=t,this.app=s,this.context=n,this.token=i,this.type!==M&&this.type!==L&&this.type!==F)throw new Error(`Unsupported type: ${this.type}.`);if((null!=this.user_id?this.user_id.length:0)>C)throw new Error("user_id must be <= 256 chars.");if(this.app.length>32)throw new Error("app must be <= 32 chars.");if((null!=this.context?this.context.length:0)>64)throw new Error("context must be <= 64 chars.")}}class O{constructor(e,t){this.presence_params=e,this.agents=t}}class b{constructor(e,t){this.presence_params=e,this.status=t}}b.Status={Offline:1,Online:2};class w{constructor(e,t,s){this.presence_params=e,this.snapshot=t,this.delta=s}}class y{constructor(e,t,s,i=(()=>{})){this._backoff_window=g,this._heartbeat=()=>{if(!this._started||0===this._presence_data.length)return;this._offline_agents=this._presence_data.filter((e=>""!==e.status)).map((e=>e.agent)),this._has_changes=!1;const e=new AbortController;this._heartbeat_xhr=fetch(`https://${this.beaconUrl}/1/update`,{method:"POST",body:JSON.stringify({token:this._token,updates:this._presence_data}),headers:{"Content-Type":"application/json; charset=utf-8"},credentials:"include",signal:e.signal}).then((e=>e.json())).then(this._handle_heartbeat_success).catch(this._handle_heartbeat_error),setTimeout((()=>e.abort()),5e3)},this._handle_heartbeat_success=e=>{if(this._heartbeat_xhr=void 0,!this._started)return;const t=[];for(const s of e.agent_errors||[]){const e=s.error,i=P.from_json(s.agent);if("authorization_error"===e)t.push(i);else if("invalid_agent"===e)throw new Error(`Input error: ${s}`);this._presence_data=this._presence_data.filter((e=>!n.lodashExports.isEqual(e.agent,i)))}if(t.length){const e=this._authz_cb;window.setTimeout((()=>e(t)),0)}for(const e of this._offline_agents)for(let t=0;t<this._presence_data.length;t++){const s=this._presence_data[t];if(n.lodashExports.isEqual(s.agent,e)&&""===s.status){this._presence_data.splice(t,1);break}}const s=this._has_changes?0:6e4;this._backoff_window=g,this._timeout_id=window.setTimeout(this._heartbeat,s)},this._handle_heartbeat_error=e=>{if(this._heartbeat_xhr=void 0,!this._started)return;if(e.status>=400&&e.status<500&&401===e.status)return window.setTimeout(this._authn_cb,0),void this.stop();const t=Math.random()*this._backoff_window;this._backoff_window=Math.min(2*this._backoff_window,12e4),this._timeout_id=window.setTimeout(this._heartbeat,t)},this._token=e,this._authn_cb=s,this._authz_cb=i,this._started=!1,this._presence_data=[],this._offline_agents=[],this._has_changes=!1,this.beaconUrl=t}start(){if(!this._started)return this._backoff_window=g,this._started=!0,this._has_changes=!1,this._heartbeat()}stop(){this._started=!1,this._heartbeat_xhr=void 0,window.clearTimeout(this._timeout_id),this._timeout_id=void 0}add_or_update_agents(e){for(const t of e)this._has_changes=this._add_or_update_agent(t)||this._has_changes;!this._heartbeat_xhr&&this._started&&(window.clearTimeout(this._timeout_id),this._timeout_id=window.setTimeout(this._heartbeat,0))}_add_or_update_agent(e){for(let t=0;t<this._presence_data.length;t++){const s=this._presence_data[t];if(n.lodashExports.isEqual(s.agent,e.agent))return(s.status!==e.status||s.auth_key!==e.auth_key)&&(this._presence_data[t]=e,!0)}return this._presence_data.push(e),!0}}class D{constructor(e,t,i,a){this._compact_context_updates=(e,t)=>{let s,i,a=!1,r=[];for(const e of t)if(null!=e.snapshot)a=!0,r=e.snapshot;else if(null!=e.delta)for(const t of e.delta){let e=!1;for(let s=0;s<r.length;s++){const i=r[s];if(n.lodashExports.isEqual(i.agent,t.agent)){e=!0,r[s]=t;break}}e||r.push(t)}return a?(i=r,s=void 0):(i=void 0,s=r),new w(e,i,s)},this._on_update=e=>{const t=[];for(const n of e){const{channel_state:e}=n,i=new s.ChannelId(e.app_id,e.unique_id),a=this._bolt_channel_to_presence_params(i);switch(a.type){case M:{const{payload:e}=n.payloads.slice(-1)[0],s=null!=e.agents?e.agents.map(R.from_json):[];t.push(new O(a,s));break}case L:{const{payload:e}=n.payloads.slice(-1)[0];t.push(new b(a,e.status));break}case F:{const e=function(e){const t=N.from_json(e.source),s=new P(e.user_id,a.app,a.context,t);return new R(s,e.status)},s=function(t){var s,n,i,a;return{snapshot:null===(n=null===(s=t.snapshot)||void 0===s?void 0:s.agents)||void 0===n?void 0:n.map(e),delta:null===(a=null===(i=t.delta)||void 0===i?void 0:i.agents)||void 0===a?void 0:a.map(e)}},i=n.payloads.map((e=>s(e.payload)));t.push(this._compact_context_updates(a,i));break}}}return this._update_callback(t)},this._on_refresh=e=>this._refresh_callback(e.map(this._bolt_channel_to_presence_params)),this._presence_params=e,this._update_callback=t,this._refresh_callback=i;const r=this._presence_params.map(this._presence_params_to_bolt_channel);this._thunder_client=new s.ThunderClient(r,this._on_update,this._on_refresh,a)}start(){return this._thunder_client.start()}stop(){return this._thunder_client.unsubscribe()}_presence_params_to_bolt_channel(e){switch(e.type){case M:return new s.SignedChannelState(`beacon_uc${A}${e.app}`,`${e.user_id}|${e.context}`,"0",e.token);case L:return new s.SignedChannelState(`beacon_ua${A}${e.app}`,e.user_id||"","0",e.token);case F:return new s.SignedChannelState(`beacon_c${A}${e.app}`,e.context,"0",e.token);default:throw new Error(`Unknown type: ${e.type}`)}}_bolt_channel_to_presence_params(e){const t=e.app_id.split(A),s=e.unique_id.split("|");if(2!==t.length)throw new Error(`Unexpected format of Bolt app_id: ${e.app_id}.`);const n=t[1];let i="",a="",r=M;switch(t[0]){case"beacon_uc":if(2!==s.length)throw new Error(`Unexpected format of beacon_uc: ${e.unique_id}.`);r=M,i=s[0],a=s[1];break;case"beacon_ua":if(1!==s.length)throw new Error(`Unexpected format of beacon_ua: ${e.unique_id}.`);r=L,i=s[0];break;case"beacon_c":if(1!==s.length)throw new Error(`Unexpected format of beacon_c: ${e.unique_id}.`);r=F,a=s[0];break;default:throw new Error(`Unknown Bolt app_id: ${e.app_id}.`)}return new U(r,i,n,a,void 0)}}function v(e){return e.ns("seen_state")}class k{static passPermissionRequest(e){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.PASS_PERMISSION_REQUEST,data:{fileId:e}})}static updatePermissions(e,t){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.UPDATE_PERMISSIONS,data:{fileId:e,partialPermission:t}})}static fetchPassError(e){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.FETCH_PASS_ERROR,data:{fileId:e}})}static fetchPassConcluded(e){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.FETCH_PASS_CONCLUDED,data:{fileId:e}})}static receivePresenceDelta(e,t,n,a){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.RECEIVE_PRESENCE_DELTA,data:{userId:e,fileId:t,onlineUniqueUsers:n,offlineUniqueUsers:a}})}static receivePresenceSnapshot(e,t,n){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.RECEIVE_PRESENCE_SNAPSHOT,data:{userId:e,fileId:t,onlineUniqueUsers:n}})}static resetPassInfo(e){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.RESET_PASS_INFO,data:{fileId:e}})}static updateSeenStateInfo(e,t,n){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.UPDATE_SEEN_STATE_INFO,data:{fileId:e,seenStateInfo:t,seenStateCursor:n}})}static updateUserTeamInteractionInfo(e,t){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.UPDATE_USER_TEAM_INTERACTION_INFO,data:{fileId:e,userTeamInteractionInfo:t}})}static updateSeenStateInfoContinue(e,t,n){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.UPDATE_SEEN_STATE_INFO_CONTINUE,data:{fileId:e,seenStateInfo:t,seenStateCursor:n}})}static discontinueSeenStateInfo(e){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.DISCONTINUE_SEEN_STATE_INFO,data:{fileId:e}})}static updateSeenStateUnavailable(e,t){i.dispatcherSingleton.dispatch({type:s.ActionTypes$1.UPDATE_SEEN_STATE_UNAVAILABLE,data:{userId:e,fileId:t}})}}const H=[s.LoggingActions.PRESENCE_RECEIVE,s.LoggingActions.TRANSMITTER_TOKEN_BEGIN,s.LoggingActions.TRANSMITTER_TOKEN_RECEIVE,s.LoggingActions.RECEIVER_TOKEN_BEGIN,s.LoggingActions.RECEIVER_TOKEN_RECEIVE,s.LoggingActions.SEEN_STATE_USERS_BEGIN,s.LoggingActions.SEEN_STATE_USERS_RECEIVE];const V=new class{constructor(){this.allTimestamps={}}record(e,t){const s=(new Date).getTime()/1e3;this.allTimestamps[t]=this.allTimestamps[t]||{};const n=this.allTimestamps[t];n.hasOwnProperty(e)?this.reportStackForRepeatedAction(n,e,t,s):n[e]=s}get(e){return this.allTimestamps[e]||{}}reportStackForRepeatedAction(e,t,s,n){if(H.indexOf(t)>=0)return;const i=e[t];a.reportStack("Attempted to record action for which there existed a previous record",{severity:a.SEVERITY.NONCRITICAL,tags:["pass:actionTimestampsTracker"],exc_extra:{pass_session_id:s,action:t,oldTimestamp:i,newTimestamp:n}})}},x=s.createApiv2Query({nsClient:v,rpc:"get_seen_state_info"}),B=(e,t)=>[{file_identifier:e,shared_link_details:t?{url:t}:void 0}];function G(e){k.resetPassInfo(e),k.fetchPassError(e)}function K(e,t){return{file_identifier:e,shared_link_details:t?{url:t}:void 0}}var q;!function(e){e.create=function(e){return e?new s.FetchAsyncTransport:new s.FetchSyncTransport}}(q||(q={}));class W{static constructFakeSeenStateInfo(e,t,s){const n=s.seen_states,i=[];for(const e of n)i.push(e.seen_state_user.user_id);for(const s of e)if(!i.includes(s.user_id)){s.sharing_access_type&&(s.sharing_access_type=s.sharing_access_type);const e={seen_state_user:s,when_last_seen:t,seen_events:[]};n.unshift(e)}return s.seen_states=n,s}static parseSeenStatePassPlatform(e){if(e){switch(s.Union.parse(e).type){case"web":return s.PassPlatform.WEB;case"mobile":return s.PassPlatform.MOBILE;case"desktop":return s.PassPlatform.DESKTOP}}return s.PassPlatform.UNKNOWN}static async fetchSeenStateUsers(e,t,n,i,a,r){const o=Date.now()/1e3;let c;r&&V.record(s.LoggingActions.SEEN_STATE_USERS_BEGIN,r);try{c=await v(new s.DefaultUserApiV2Client(e)).rpc("get_seen_state_users",{user_ids:n,file_info:K(i,a)},{})}catch{return void G(i)}r&&V.record(s.LoggingActions.SEEN_STATE_USERS_RECEIVE,r);const _=this.constructFakeSeenStateInfo(c,o,t);k.updateSeenStateInfo(i,_)}static processAndUpdateSeenStateInfo(e,t,n){const{seen_state_info:i,seen_state_error:a,seen_state_cursor:r}=t[0];if(a)if(n)k.discontinueSeenStateInfo(e);else{if("no_permission"===s.Union.parse(a).type)return;G(e)}else{for(const e of i.seen_states)e.platform_type=this.parseSeenStatePassPlatform(e.platform_type);n?k.updateSeenStateInfoContinue(e,i,r):k.updateSeenStateInfo(e,i,r)}}static async fetchSeenStateInfo(e,t,n,i,a){let o;a&&V.record(s.LoggingActions.SEEN_STATE_BEGIN,a);try{const e=await(async(e,t,s)=>await x.fetchQuery(r.queryClient,{apiArg:{file_infos:B(e,t),limit:s}}))(t,i,n);o=e.apiData}catch{return void G(t)}let c=!0;const{seen_state_info:_,seen_state_error:l}=o[0];c=!(!_||l),k.updatePermissions(t,{canReadSeenState:c}),c||k.updateSeenStateUnavailable(e.id,t),c&&a&&V.record(s.LoggingActions.SEEN_STATE_RECEIVE,a),this.processAndUpdateSeenStateInfo(t,o,!1),c&&this.fetchRemainingSeenStateInfo(e,t,o,i)}static fetchRemainingSeenStateInfo(e,t,s,n){const i=s[0].seen_state_cursor;if(i&&i.has_next){const s=i.cursor_state;s&&this.fetchSeenStateInfoContinue(e,t,s,1e5,n)}}static async fetchSeenStateInfoContinue(e,t,n,i,a){let r;try{r=await v(new s.DefaultUserApiV2Client(e)).rpc("get_seen_state_info/continue",{file_infos:[K(t,a)],cursor:n,limit:i},{})}catch{return void k.discontinueSeenStateInfo(t)}this.processAndUpdateSeenStateInfo(t,r,!0)}static updateSeenStateOnResign(e,t,n,i,a,r){const o=q.create(n);return function(e,t,n,i,a){return e?t(v(new s.DefaultUserApiV2Client(e,a)),i):n(v(new s.NoAuthApiV2Client(a)),i)}(e||void 0,((e,t)=>e.rpc("update_timestamps_and_mark_offline",t,{})),((e,t)=>e.rpc("logged_out/mark_offline",t,{})),{beacon_infos:[{beacon_user_id:i,context:r,shared_link_url:t.url,identifier:a}]},o)}}const $="online";function Q(e){k.resetPassInfo(e),k.fetchPassError(e)}class j{static resetClassState(){delete this.receiverData,delete this.transmitterData,delete this.lastFileIdForReceiverTokenRequest,delete this.lastFileIdForTransmitterTokenRequest}static shutdown({viewer:e,beaconFileData:t,user:n,async:i,shouldWritePresence:a=!0}){if(delete this.lastFileIdForReceiverTokenRequest,delete this.lastFileIdForTransmitterTokenRequest,this.transmitterData){const{beaconUserId:r,context:o,identifier:c}=this.transmitterData;this.transmitterData.transmitter.stop(),delete this.transmitterData,!e.is_assume_user_session&&a&&W.updateSeenStateOnResign(n,t,i,r,c,o).catch((()=>{s.UDCL.logEvent("ops.pass.error",{tags:{reason:"update_seen_state_on_resign"}})}))}this.receiverData&&this.receiverData.receiver&&(this.receiverData.receiver.stop(),delete this.receiverData)}static async receiveBeaconData({beaconFileData:e,user:t,passSessionId:n,onUpdate:i}){const{fileId:a}=e;n&&V.record(s.LoggingActions.RECEIVER_TOKEN_BEGIN,n),this.lastFileIdForReceiverTokenRequest=a;const r=await this.fetchReceiverToken(t,e).catch((()=>{s.UDCL.logEvent("ops.pass.error",{tags:{reason:"fetch_receiver_token"}})}));if(!r)return;if(this.lastFileIdForReceiverTokenRequest!==a)return;if(r.beacon_presence_error)return k.updatePermissions(a,{canReadPresence:!1}),void("no_permission"===r.beacon_presence_error[".tag"]||Q(a));k.updatePermissions(a,{canReadPresence:!0}),n&&V.record(s.LoggingActions.RECEIVER_TOKEN_RECEIVE,n);const o=[new U(F,t.account_id,this.APP,r.beacon_presence_info.context,r.beacon_presence_info.token)];this.receiverData&&this.receiverData.receiver&&this.receiverData.receiver.stop(),this.receiverData={authKey:r.beacon_presence_info.auth_key,receiver:new D(o,(a=>{n&&V.record(s.LoggingActions.PRESENCE_RECEIVE,n);const r=this.parseBeaconUpdates(a[0]);i(r,t.id,e)}),(()=>this.receiveBeaconData({user:t,beaconFileData:e,passSessionId:n,onUpdate:i})),"thunder.dropbox.com"),context:r.beacon_presence_info.context},this.receiverData.receiver.start()}static fetchReceiverToken(e,t){const{fileId:n,url:i}=t,a={file_info:X(n,i)};return s.GetFilePresenceRoutes(new s.DefaultUserApiV2Client(e)).rpc("get_pass_receiver_token",a,{})}static isOnline(e){return e&&this.HARMONY_ONLINE_STATUSES.includes(e)||e===$}static parseBeaconUpdates(e){const t={},s={},n="delta"in e?"delta":"snapshot",i="delta"in e&&e.delta?e.delta:"snapshot"in e&&e.snapshot?e.snapshot:[];for(const e of i){const n=e.agent,i=n.user_id,a=n.source.identifier;this.isOnline(e.status)?(i in t||(t[i]={}),t[i][a]=!0):(i in s||(s[i]={}),s[i][a]=!0)}return{onlineUniqueUsers:t,offlineUniqueUsers:s,type:n}}static async transmitBeaconData({user:e,passSessionId:t,beaconFileData:n,prevBeaconFileData:i}){const{fileId:a}=n;this.transmitterData&&i&&(this.transmitterData.transmitter.add_or_update_agents([this.getAgentStatusForFile(this.transmitterData.beaconUserId,this.transmitterData.identifier,this.transmitterData.authKey,this.transmitterData.context,"")]),setTimeout((()=>{var e;null===(e=this.transmitterData)||void 0===e||e.transmitter.stop()}),1)),t&&V.record(s.LoggingActions.TRANSMITTER_TOKEN_BEGIN,t),this.lastFileIdForTransmitterTokenRequest=a;const r=await this.fetchTransmitterToken(e,n);if(this.lastFileIdForTransmitterTokenRequest===a){if(r.beacon_presence_error)return k.updatePermissions(a,{canWritePresence:!1}),void("no_permission"===r.beacon_presence_error[".tag"]||Q(a));k.updatePermissions(a,{canWritePresence:!0}),t&&V.record(s.LoggingActions.TRANSMITTER_TOKEN_RECEIVE,t),this.transmitterData={identifier:s.UUID.v4(),beaconUserId:r.beacon_presence_info.beacon_user_id,authKey:r.beacon_presence_info.auth_key,transmitter:new y(r.beacon_presence_info.token,"beacon.dropbox.com",(()=>this.transmitBeaconData({user:e,passSessionId:t,beaconFileData:n,prevBeaconFileData:null}))),context:r.beacon_presence_info.context},this.transmitterData.transmitter.add_or_update_agents([this.getAgentStatusForFile(this.transmitterData.beaconUserId,this.transmitterData.identifier,this.transmitterData.authKey,this.transmitterData.context,$)]),this.transmitterData.transmitter.start()}}static getAgentStatusForFile(e,t,s,n,i){const a=new N(this.PLATFORM,this.SURFACE,t),r=new P(e,this.APP,n,a);return new R(r,i,s)}static async fetchTransmitterToken(e,t){const{fileId:n,url:i}=t,o={file_info:X(n,i)};e||i||a.reportStack("For logged out user URL is needed for get_pass_transmitter_token",{tags:["file_presence","file_presence_js"],severity:"non-critical"});return(await s.passFacepilePackage(null==e?void 0:e.id).fetchQuery(r.queryClient,{apiArg:o})).apiData}}function X(e,t){return t?{".tag":"shared_link_details",url:t}:{".tag":"file_identifier",file_identifier:e}}j.APP="harmony",j.PLATFORM=T.WEB,j.SURFACE="file_viewer",j.HARMONY_ONLINE_STATUSES=["modifier","viewer"];class Y{constructor(){this.userIdToUniqueIds={}}addUniqueUser(e,t){e in this.userIdToUniqueIds||(this.userIdToUniqueIds[e]={}),this.userIdToUniqueIds[e][t]=!0}removeUniqueUser(e,t){e in this.userIdToUniqueIds&&t in this.userIdToUniqueIds[e]&&(delete this.userIdToUniqueIds[e][t],Object.keys(this.userIdToUniqueIds[e]).length||delete this.userIdToUniqueIds[e])}getOnlineUserIds(){return Object.keys(this.userIdToUniqueIds)}}class z extends d.Store{constructor(e){super(e),this.seenStateInfos={},this.seenStateCursors={},this.presenceInfos={},this.passFetchingStatusMap={},this.userIdsWithoutSeenStateInfoMap={},this.userIdsWithoutTeamInteractionInfoMap={},this.userTeamInteractionInfoMap={},this.passPermissions={}}presence(e){return e in this.presenceInfos?this.presenceInfos[e].getOnlineUserIds():null}seenStateInfo(e){return this.seenStateInfos[e]||null}identifiedSeenStateInfo(e){if(e in this.seenStateInfos){return{seen_states:n.reject(this.seenStateInfos[e].seen_states,s.AnonymousViewerUtils.isAnonymousSeenState)}}return null}seenStateCursorHasNext(e){return e in this.seenStateCursors?this.seenStateCursors[e].has_next:null}seenStateCursorState(e){return e in this.seenStateCursors?this.seenStateCursors[e].cursor_state:null}passFetchingStatus(e){return this.passFetchingStatusMap[e]||s.PassFetchingStatus.NOT_YET_KNOWN}getLinkAndGroupSeenStateInfo(e){let t=null,n=null;if(!this.seenStateInfos[e])return{linkSeenStateInfo:t,groupSeenStateInfo:n};t=[],n={};for(const i of this.seenStateInfos[e].seen_states)if(!s.AnonymousViewerUtils.isAnonymousSeenState(i)){const{seen_state_user:{sharing_access_type:e}}=i;if(e)switch(e[".tag"]){case"link_only":case"view_link_access":case"edit_link_access":t.push(i);break;case"view_member_access":case"edit_member_access":const s=e.group_ids;for(const e of s)e in n||(n[e]=[]),n[e].push(i)}}return{linkSeenStateInfo:t,groupSeenStateInfo:n}}anonymousPresence(e){return e in this.presenceInfos?s.AnonymousViewerUtils.getAnonymousUserIds(this.presenceInfos[e].getOnlineUserIds()):null}userIdsWithoutSeenStateInfo(e){return this.userIdsWithoutSeenStateInfoMap[e]||[]}userIdsWithoutTeamInteractionInfo(e){return this.userIdsWithoutTeamInteractionInfoMap[e]||[]}userTeamInteractionInfo(e){return this.userTeamInteractionInfoMap[e]||{}}isPassPermissionsPending(e){const t=this.passPermissions[e];return null!=t&&!(t.hasOwnProperty("canReadPresence")&&t.hasOwnProperty("canReadSeenState")&&t.hasOwnProperty("canWritePresence"))}getPassPermissions(e){if(!e)return null;const t=this.passPermissions[e];return null==t||this.isPassPermissionsPending(e)?null:t}resetPassInfo(e){delete this.seenStateInfos[e],delete this.seenStateCursors[e],delete this.presenceInfos[e],delete this.passFetchingStatusMap[e],delete this.passPermissions[e],delete this.userIdsWithoutSeenStateInfoMap[e],this.emit_change()}setPassPermissionRequest(e){this.passPermissions[e]||(this.passPermissions[e]={}),this.setPassFetchingStatus(e,s.PassFetchingStatus.FETCHING)}updatePermissions(e,t){this.passPermissions.hasOwnProperty(e)&&(this.passPermissions[e]={...this.passPermissions[e],...t},this.emit_change())}markPassConcludedIfNecessary(e){const t=this.passPermissions[e];!(t&&t.hasOwnProperty("canReadPresence")&&t.hasOwnProperty("canReadSeenState"))||t.canReadPresence||t.canReadSeenState||(this.resetPassInfo(e),this.setPassFetchingStatus(e,s.PassFetchingStatus.CONCLUDED),this.updateSeenStateInfoWithEmptyData(e))}receivePresenceDelta(e,t,n,i){u.assert(-1===[s.PassFetchingStatus.FETCHING,s.PassFetchingStatus.NOT_YET_KNOWN].indexOf(this.passFetchingStatus(t)),"Before handling a presence delta, you must call assurePresenceSuccessRegistered");const a=this.getOnlineUsersForFileId(t);this.updatePresenceInfos(t,n,i),this.updateUserIdsWithoutSeenStateInfo(e,t,a),this.emit_change()}receivePresenceSnapshot(e,t,n){u.assert(-1===[s.PassFetchingStatus.FETCHING,s.PassFetchingStatus.NOT_YET_KNOWN].indexOf(this.passFetchingStatus(t)),"Before handling a presence snapshot, you must call assurePresenceSuccessRegistered");const i=this.getOnlineUsersForFileId(t);this.presenceInfos[t]=new Y,this.updatePresenceInfos(t,n,{}),this.updateUserIdsWithoutSeenStateInfo(e,t,i),this.emit_change()}getOnlineUsersForFileId(e){return e in this.presenceInfos||(this.presenceInfos[e]=new Y),this.presenceInfos[e].getOnlineUserIds()}updatePresenceInfos(e,t,s){for(const t of Object.keys(s))for(const n of Object.keys(s[t]))this.presenceInfos[e].removeUniqueUser(t,n);for(const s of Object.keys(t))for(const n of Object.keys(t[s]))this.presenceInfos[e].addUniqueUser(s,n)}updateUserIdsWithoutSeenStateInfo(e,t,i){let a;const r=s.AnonymousViewerUtils.filterAnonymousUserIds(this.getOnlineUsersForFileId(t)),o=s.AnonymousViewerUtils.filterAnonymousUserIds(i),c=n.difference(o,r),_=n.difference(r,o);if(t in this.seenStateInfos){let e;const n=this.passFetchingStatus(t);if(-1!==[s.PassFetchingStatus.SEEN_STATE_DISALLOWED,s.PassFetchingStatus.PASS_MIXED_SUCCESS].indexOf(n))({userIdsWithoutSeenStateInfo:a,baseSeenStateInfo:e}=this.createMinimalBaseSeenStateInfo(t,r)),this.updateSeenStateInfo(t,e);else{const s=this.makeSeenStateAgreeWithUpdatedPresence(t,r,c,_);({userIdsWithoutSeenStateInfo:a,baseSeenStateInfo:e}=s)}}else a=[];this.userIdsWithoutSeenStateInfoMap[t]=a}makeSeenStateAgreeWithUpdatedPresence(e,t,s,n){const i=[],a=this.seenStateInfos[e],r=a.seen_states,o=[],c=[],_=[],l=Date.now()/1e3;for(const e of r){const t=e.seen_state_user.user_id;t&&(i.push(t),n.includes(t)?(e.when_last_seen=l,e.seen_events=e.seen_events||[],c.push(e)):s.includes(t)?(e.when_last_seen=l,e.seen_events=e.seen_events||[],e.seen_events.push({ts:l}),_.push(e)):o.push(e))}return a.seen_states=[...c,..._,...o],{userIdsWithoutSeenStateInfo:t.filter((e=>!i.includes(e))),baseSeenStateInfo:a}}createMinimalBaseSeenStateInfo(e,t){const s=[],i=[];for(const n of this.seenStateInfos[e].seen_states){const e=n.seen_state_user.user_id;e&&t.includes(e)&&(s.push(n),i.push(e))}return{userIdsWithoutSeenStateInfo:n.difference(t,i),baseSeenStateInfo:{seen_states:s}}}updateSeenStateInfo(e,t,n=!1){u.assert(-1===[null,s.PassFetchingStatus.FETCHING].indexOf(this.passFetchingStatus(e)),"Before updating seen state info, you must call assureSeenStateSuccessRegistered or onFetchSeenStateDisabled"),n&&e in this.seenStateInfos?this.seenStateInfos[e].seen_states=this.seenStateInfos[e].seen_states.concat(t.seen_states):this.seenStateInfos[e]=t,this.userIdsWithoutTeamInteractionInfoMap[e]=this.userIdsWithoutSeenStateInfoMap[e],this.userIdsWithoutSeenStateInfoMap[e]=[],this.emit_change()}updateSeenStateInfoWithEmptyData(e){this.updateSeenStateInfo(e,{seen_states:[]})}setPassFetchingStatus(e,t){this.passFetchingStatusMap[e]=t,this.emit_change()}updateSeenStateCursor(e,t){t&&(this.seenStateCursors[e]=t,this.emit_change())}assureSeenStateSuccessRegistered(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.SEEN_STATE_SUCCESS);break;case s.PassFetchingStatus.PRESENCE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_SUCCESS);break;case s.PassFetchingStatus.SEEN_STATE_DISALLOWED:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"assure_registered_but_disallowed"}});break;case s.PassFetchingStatus.NOT_YET_KNOWN:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"registered_not_yet_known"}})}}onFetchSeenStateDisabled(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.PRESENCE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_MIXED_SUCCESS);break;case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.SEEN_STATE_DISALLOWED);break;case s.PassFetchingStatus.NOT_YET_KNOWN:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"disabled_not_yet_known"}})}}assurePresenceSuccessRegistered(e){switch(this.passFetchingStatus(e)){case s.PassFetchingStatus.SEEN_STATE_SUCCESS:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_SUCCESS);break;case s.PassFetchingStatus.SEEN_STATE_DISALLOWED:this.setPassFetchingStatus(e,s.PassFetchingStatus.PASS_MIXED_SUCCESS);break;case s.PassFetchingStatus.FETCHING:this.setPassFetchingStatus(e,s.PassFetchingStatus.PRESENCE_SUCCESS);break;case s.PassFetchingStatus.NOT_YET_KNOWN:s.UDCL.logEvent("ops.pass.seen_state_store_race_condition",{tags:{reason:"presence_registered_not_yet_known"}})}}updateUserTeamInteractionInfo(e,t){if(e in t)for(const s of Object.keys(t))this.userTeamInteractionInfoMap[e][s]=t[s];else this.userTeamInteractionInfoMap[e]=t;this.userIdsWithoutTeamInteractionInfoMap[e]=[],this.emit_change()}_new_payload(e){const{type:t,data:n}=e.action;if(!n)return;let{userId:i,fileId:a,teamId:r,seenStateInfo:o,seenStateCursor:c,onlineUniqueUsers:_,offlineUniqueUsers:l,partialPermission:d,userTeamInteractionInfo:u,userTeamInteractionUserIds:h}=n;switch(t){case s.ActionTypes$1.FETCH_PASS_ERROR:this.setPassFetchingStatus(a,s.PassFetchingStatus.ERROR);break;case s.ActionTypes$1.FETCH_PASS_CONCLUDED:this.setPassFetchingStatus(a,s.PassFetchingStatus.CONCLUDED),this.updateSeenStateInfoWithEmptyData(a);break;case s.ActionTypes$1.PASS_PERMISSION_REQUEST:this.setPassPermissionRequest(a);break;case s.ActionTypes$1.RECEIVE_PRESENCE_DELTA:this.assurePresenceSuccessRegistered(a),this.receivePresenceDelta(i,a,_,l);break;case s.ActionTypes$1.RECEIVE_PRESENCE_SNAPSHOT:this.assurePresenceSuccessRegistered(a),this.receivePresenceSnapshot(i,a,_);break;case s.ActionTypes$1.RESET_PASS_INFO:this.resetPassInfo(a);break;case s.ActionTypes$1.UPDATE_PERMISSIONS:this.updatePermissions(a,d),this.markPassConcludedIfNecessary(a);break;case s.ActionTypes$1.DISCONTINUE_SEEN_STATE_INFO:c={cursor_state:"",has_next:!1},this.updateSeenStateCursor(a,c);break;case s.ActionTypes$1.UPDATE_SEEN_STATE_INFO:this.assureSeenStateSuccessRegistered(a),this.updateSeenStateInfo(a,o),this.updateSeenStateCursor(a,c);break;case s.ActionTypes$1.UPDATE_SEEN_STATE_INFO_CONTINUE:this.assureSeenStateSuccessRegistered(a),this.updateSeenStateInfo(a,o,!0),this.updateSeenStateCursor(a,c);break;case s.ActionTypes$1.UPDATE_SEEN_STATE_UNAVAILABLE:this.onFetchSeenStateDisabled(a),this.updateSeenStateInfoWithEmptyData(a),this.updateUserIdsWithoutSeenStateInfo(i,a,[]);break;case s.ActionTypes$1.UPDATE_USER_TEAM_INTERACTION_INFO:this.updateUserTeamInteractionInfo(a,u)}}}const J=new z;class Z{constructor(e,t,s,n,i,a,r,o,c){this.key=e,this.displayName=t,this.isActive=s,this.email=n,this.whenLastSeen=i,this.photoUrl=a,this.userId=r,this.sameTeam=o,this.isGuest=c}}class ee{constructor(e,t){this.isLoaded=e,this.data=t}static create(e){return new ee(!0,e)}static createNotLoaded(){return new ee(!1,null)}}class te{constructor(e,t){this.fileId=e,this.url=t}}const se=h.withActionNamespace("share-modal-actions",{SHARE_MODAL_OPEN:"share-modal-open",SHARE_MODAL_CLOSE:"share-modal-close",RESET_MODAL_STATE:"reset-modal-state",OPEN_LINK_SETTINGS_MODAL:"open-link-settings-modal",OPEN_FOLDER_SETTINGS_MODAL:"open-folder-settings-modal",OPEN_SHARED_LINK_MODAL:"open-shared-link-modal",CLOSE_LINK_SETTINGS_MODAL:"close-link-settings-modal",CLOSE_FOLDER_SETTINGS_MODAL:"close-folder-settings-modal",CLOSE_SHARED_LINK_MODAL:"close-shared-link-modal",CLEAR_METADATA:"clear-metadata",FETCH_METADATA_REQUEST:"metadata-request",FETCH_METADATA_SUCCESS:"metadata-success",FETCH_METADATA_FAILURE:"metadata-failure",CLEAR_LINK_METADATA:"clear-link-metadata",FETCH_LINK_METADATA_REQUEST:"link-metadata-request",FETCH_LINK_METADATA_SUCCESS:"link-metadata-success",FETCH_LINK_METADATA_FAILURE:"link-metadata-failure",CLEAR_SHARING_PREFS:"clear-sharing-prefs",FETCH_SHARING_PREFS_REQUEST:"sharing-prefs-request",FETCH_SHARING_PREFS_SUCCESS:"sharing-prefs-success",FETCH_SHARING_PREFS_FAILURE:"sharing-prefs-failure",ERROR_MESSAGE:"error-message",ERROR_MESSAGE_CLEAR:"error-message-clear",CLEAR_FILE_MEMBERSHIP:"clear-file-membership",FETCH_FILE_MEMBERSHIP_REQUEST:"fetch-file-membership-request",FETCH_FILE_MEMBERSHIP_SUCCESS:"fetch-file-membership-success",FETCH_FILE_MEMBERSHIP_FAILURE:"fetch-file-membership-failure",CLEAR_FOLDER_MEMBERSHIP:"clear-folder-membership",FETCH_FOLDER_MEMBERSHIP_REQUEST:"fetch-folder-membership-request",FETCH_FOLDER_MEMBERSHIP_SUCCESS:"fetch-folder-membership-success",FETCH_FOLDER_MEMBERSHIP_FAILURE:"fetch-folder-membership-failure",FETCH_USER_ACCOUNTS_REQUEST:"fetch-user-accounts-request",FETCH_USER_ACCOUNTS_SUCCESS:"fetch-user-accounts-success",FETCH_USER_ACCOUNTS_FAILURE:"fetch-user-accounts-failure",FETCH_USER_ACCOUNTS_CONTINUED_REQUEST:"fetch-user-accounts-continued-request",FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS:"fetch-user-accounts-continued-success",CLEAR_FILE_MEMBERSHIP_LAST_SEEN_INFO:"clear-file-membership-last-seen-info",FETCH_FILE_MEMBER_COUNT_REQUEST:"fetch-file-member-count-request",FETCH_FILE_MEMBER_COUNT_SUCCESS:"fetch-file-member-count-success",CHANGE_RECIPIENTS:"change-recipients",CHANGE_RECIPIENT_MESSAGE:"change-recipient-message",APPEND_TO_RECIPIENT_MESSAGE:"append-to-recipient-message",CHANGE_RECIPIENT_ACCESS:"change-recipient-access",UPDATE_RECIPIENT_VALIDATION:"update-recipient-validation",CREATE_LINK_REQUEST:"create-link-request",CREATE_LINK_SUCCESS:"create-link-success",CREATE_LINK_FAILURE:"create-link-failure",UPDATE_LINK_SUCCESS:"update-link-success",DISPLAY_CONTENT_NAME_INFO:"display-content-name-info",SEND_SHARE_REQUEST:"send-share-request",SEND_SHARE_SUCCESS:"send-share-success",SEND_SHARE_FAILURE:"send-share-failure",SHARE_FOLDER_REQUEST:"share-folder-request",SHARE_FOLDER_SUCCESS:"share-folder-success",SHARE_FOLDER_FAILURE:"share-folder-failure",SEND_FOLDER_SHARE_REQUEST:"send-folder-share-request",SEND_FOLDER_SHARE_SUCCESS:"send-folder-share-success",SEND_FOLDER_SHARE_FAILURE:"send-folder-share-failure",CHANGE_MEMBER_ACCESS_REQUEST:"change-member-access-request",CHANGE_MEMBER_ACCESS_SUCCESS:"change-member-access-success",CHANGE_MEMBER_ACCESS_FAILURE:"change-member-access-failure",MEMBER_ACTION_PENDING:"member-action-pending",MEMBER_ACTION_COMPLETE:"member-action-complete",REMOVE_MEMBER_SUCCESS:"remove-member-success",REMOVE_MEMBER_KEEP_ACCESS:"remove-member-keep-access",TRANSFER_OWNER_SUCCESS:"transfer-owner-success",FETCH_CURRENT_ACCOUNT_REQUEST:"fetch-current-account-request",FETCH_CURRENT_ACCOUNT_SUCCESS:"fetch-current-account-success",FETCH_MEMBER_COUNTS_REQUEST:"fetch-member-counts-request",FETCH_MEMBER_COUNTS_SUCCESS:"fetch-member-counts-success",HANDLE_CONTENT_NAME_CHANGE:"handle-content-name-change",VALIDATE_CONTENT_NAME_SUCCESS:"validate-content-name-success",VALIDATE_CONTENT_NAME_ERROR:"validate-content-name-error",CHANGE_LINK_AUDIENCE_REQUEST:"change-link-audience-request",CHANGE_LINK_AUDIENCE_SUCCESS:"change-link-audience-success",CHANGE_LINK_AUDIENCE_FAILURE:"change-link-audience-failure",UNBLOCK_MEMBER_LIST_ON_PASS_LOAD:"unblock-member-list-on-pass-load",UPDATE_SHARING_SETTINGS_SUCCESS:"update-sharing-settings-success",DELETE_LINK_METADATA_SUCCESS:"delete-link-metadata-success",CHANGE_CREATE_COMMENT_CHECKBOX:"change-create-comment-checkbox",SET_UPSELL_COUNTER_PREF:"set-upsell-counter-pref",SET_UPSELL_COUNTER_PREF_SUCCESS:"set-upsell-counter-pref-success",CHANGE_LINK_AUDIENCE_SELECTION:"change-link-audience-selection",TOGGLE_OPEN_AUTOMATIONS:"toggle-open-automations",DOCSEND_ANALYTICS_LINK_REQUEST:"docsend-analytics-link-request",DOCSEND_ANALYTICS_LINK_SUCCESS:"docsend-analytics-link-success",DOCSEND_ANALYTICS_LINK_FAILURE:"docsend-analytics-link-failure",DOCSEND_FILE_CONTEXT_REQUEST:"docsend-file-context-request",DOCSEND_FILE_CONTEXT_COMPLETE:"docsend-file-context-complete",NO_DOWNLOAD_EXIT:"no-download-exit-without-copy",SETTINGS_TOOLTIP_CLOSE:"settings-tooltip-close",DID_APPLY_BRANDING:"did-apply-branding"}),ne=h.withActionNamespace("sharing-actions",{CLEAR_EVERYTHING:"clear-everything",FETCH_METADATA_BATCH_ATTEMPT:"fetch-metadata-batch-attempt",FETCH_METADATA_BATCH_SUCCESS:"fetch-metadata-batch-success",FETCH_METADATA_BATCH_FAIL:"fetch-metadata-batch-fail"});var ie,ae,re,oe,ce,_e,le;!function(e){e[e.NO_MEMBERS=0]="NO_MEMBERS",e[e.INPUT_CONTENT_NAME=1]="INPUT_CONTENT_NAME"}(ie||(ie={})),e.CONTENT_NAME_MESSAGE_LEVELS=void 0,(ae=e.CONTENT_NAME_MESSAGE_LEVELS||(e.CONTENT_NAME_MESSAGE_LEVELS={}))[ae.INFO=0]="INFO",ae[ae.ERROR=1]="ERROR",e.FETCH_METADATA_STATUS=void 0,(re=e.FETCH_METADATA_STATUS||(e.FETCH_METADATA_STATUS={}))[re.FETCHING=0]="FETCHING",re[re.SUCCESS=1]="SUCCESS",re[re.FAIL=2]="FAIL",e.LinkabilityStates=void 0,(oe=e.LinkabilityStates||(e.LinkabilityStates={})).CAN_LINK="CAN_LINK",oe.INVITE_NO_LINK="INVITE_NO_LINK",oe.NO_INVITE_NO_LINK="NO_INVITE_NO_LINK",oe.CANT_LINK_TEAM_FOLDER="CANT_LINK_TEAM_FOLDER",oe.ERROR_FETCHING_LINK_INFO="ERROR_FETCHING_LINK_INFO",e.MODES=void 0,(ce=e.MODES||(e.MODES={})).LINK_ONLY="link-only",ce.LOADING="loading",ce.MEMBERSHIP="membership",ce.POINTER="pointer",ce.SHARE="share",ce.SHARE_SENDING="share-sending",ce.EVOLUTION="evolution",e.LINK_ONLY_REASON=void 0,(_e=e.LINK_ONLY_REASON||(e.LINK_ONLY_REASON={})).INSIDE_SHARED_FOLDER="inside_shared_folder",_e.CONTAINS_SHARED_FOLDER="contains_shared_folder",_e.LINKS_PAGE="links_page",_e.TOTAL_MOUNTS_EXCEEDED="total_mounts_exceeded",_e.HOME_MOUNTS_EXCEEDED="home_mounts_exceeded",_e.TREE_SIZE_EXCEEDED="tree_size_exceeded",e.NS_LIMIT_ERROR=void 0,(le=e.NS_LIMIT_ERROR||(e.NS_LIMIT_ERROR={})).TOTAL_MOUNTS_EXCEEDED="total_mounts_exceeded",le.HOME_MOUNTS_EXCEEDED="home_mounts_exceeded",le.TREE_SIZE_EXCEEDED="tree_size_exceeded";const de=l.intl.formatMessage({id:"mYGncD",defaultMessage:"Name your shared folder"});var ue,he,Ee;n.values(e.MODES),n.values(ie),n.values(e.CONTENT_NAME_MESSAGE_LEVELS),e.LINK_CREATION_SURFACE=void 0,(ue=e.LINK_CREATION_SURFACE||(e.LINK_CREATION_SURFACE={})).COPY_OR_CREATE_LINK_SECTION="COPY_OR_CREATE_LINK_SECTION",ue.NO_DOWNLOAD_EXPERIMENT="NO_DOWNLOAD_EXPERIMENT",e.EXP_LINK_IN_MEMBER_LIST_VARIANT=void 0,(he=e.EXP_LINK_IN_MEMBER_LIST_VARIANT||(e.EXP_LINK_IN_MEMBER_LIST_VARIANT={})).ON="ON",he.OFF="OFF",he.CONTROL="CONTROL",e.EXP_UPSELL_KIWI_PIE_VARIANT=void 0,(Ee=e.EXP_UPSELL_KIWI_PIE_VARIANT||(e.EXP_UPSELL_KIWI_PIE_VARIANT={})).OFF="OFF",Ee.M2V1="M2V1",Ee.M2P2_CONTROL="M2P2_CONTROL",Ee.M2_GOLD_PREMIUM="M2_GOLD_PREMIUM",Ee.M2_GREEN_PREMIUM="M2_GREEN_PREMIUM";const Se={canRelinquishMembership:!1,contentInfo:E.ContentInfo.createFromParams({fqPath:"",isFolder:!1}),contentNameInputValue:"",contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.INFO,initialProps:{},initialRecipientTokens:[],isContentNameFocused:!1,pendingMemberAction:s.immutableExports.Set(),recipientMessage:"",recipientRawInput:"",recipientTokens:[],recipientValidation:{},referrer:"",shareAsConfidential:!1,uiMode:e.MODES.MEMBERSHIP,fetchMetadataStatus:e.FETCH_METADATA_STATUS.FETCHING,automationOptionChecked:!1,docsendAnalyticsLink:{status:"initial"},docSendFileContext:{status:"initial"},settingsTooltipHasBeenClosed:!1};function pe(e,t){return t.shared_folder_id?e.setNsId(t.shared_folder_id):e}const me={areMembersFullyLoaded:!1,areSharingPrefsLoaded:!1,sharingPrefsFetchComplete:!1,hasDisplayableMembers:!1,isLinkMetadataLoaded:!1,isCurrentAccountLoaded:!1,shouldBlockMemberListOnPassLoad:!0,memberCounts:new s.MemberCounts,members:new s.SharingMembership,sharingPrefs:new s.SharingPrefs,sharedLinks:[],selectedAudience:void 0,didApplyBranding:!1};function fe(e,t){const s=e.metadata,n=t.permissions||s&&s.permissions;return t.set("permissions",n)}const Ie=e=>[e.shared_folder_id,e.id,e.path_lower].filter((e=>!!e)),ge=e=>"V1"===e||"V3"===e,Ce="public";var Ae;e.LinkAudienceDisallowedReason=void 0,(Ae=e.LinkAudienceDisallowedReason||(e.LinkAudienceDisallowedReason={})).DeleteAndRecreate="delete_and_recreate",Ae.RestrictedBySharedFolder="restricted_by_shared_folder",Ae.RestrictedByTeam="restricted_by_team",Ae.UserAccountType="user_account_type",Ae.UserNotOnTeam="user_not_on_team",Ae.PermissionDenied="permission_denied";const Te=(e,t)=>((t=String(t)).startsWith("id:")||(t=t.toLowerCase()),`${e}::${t}`);class Ne extends d.Store{constructor(){super(),this.sharingInfoMap={}}getSharingInfo(e,t){return t?this.sharingInfoMap[Te(e,t)]:null}mapContentIdsToSharingInfo(e,t,s){for(const n of t)n&&(this.sharingInfoMap[Te(e,n)]=s)}_new_payload(e){if(e&&e.action&&e.action.type)switch(e.action.type){case ne.CLEAR_EVERYTHING:this.sharingInfoMap={};break;case ne.FETCH_METADATA_BATCH_SUCCESS:{const t=e.action.user;e.action.data.forEach((e=>{this._new_payload_for_single_content(se.FETCH_METADATA_SUCCESS,t,Ie(e),{metadata:e})})),this.emit_change();break}default:if(!e.action.contentIds)return;this._new_payload_for_single_content(e.action.type,e.action.user,e.action.contentIds,e.action.data),this.emit_change()}}_new_payload_for_single_content(t,n,i,a){let r;u.assert(Boolean(n.id),"valid user needed"),u.assert(i.length>0,"contentIds cannot be empty");for(const e of i){const t=Te(n.id,e);if(t in this.sharingInfoMap){r=this.sharingInfoMap[t];break}}r||(r=new Me(n));const o={type:t,payload:a,user:n};return r.setState(((t,n)=>{const i=n.payload;switch(n.type){case se.CHANGE_CREATE_COMMENT_CHECKBOX:return{...t,isShareMessageAsCommentExplicitlyChecked:i.checked};case se.CHANGE_RECIPIENTS:{const s=i.recipientTokens,n=i.recipientRawInput;let a=t.uiMode;return s.length>0||n.length>0?a===e.MODES.MEMBERSHIP&&(a=e.MODES.SHARE):a===e.MODES.SHARE&&(a=e.MODES.MEMBERSHIP),{...t,recipientTokens:s,recipientRawInput:n,uiMode:a}}case se.CHANGE_RECIPIENT_ACCESS:return{...t,recipientAccess:i.newAccess};case se.CHANGE_RECIPIENT_MESSAGE:return{...t,recipientMessage:i.message};case se.APPEND_TO_RECIPIENT_MESSAGE:const n=t.recipientMessage,a=i.messageToAppend;return{...t,recipientMessage:0===n.length?a:n+"\n"+a};case se.UPDATE_RECIPIENT_VALIDATION:const r=i.recipientValidation,o=i.resetCurrentValidations?{}:t.recipientValidation,c={};return s.ACCESS_VALUES.forEach((e=>{const t=o[e]||{},s=r[e]||{};c[e]={...t,...s}})),{...t,recipientValidation:c};case se.FETCH_METADATA_FAILURE:return{...t,uiMode:e.MODES.LINK_ONLY,linkOnlyReason:t.linkOnlyReason!==e.LINK_ONLY_REASON.LINKS_PAGE?i.reason:t.linkOnlyReason,fetchMetadataStatus:e.FETCH_METADATA_STATUS.FAIL,countsExceedNsLimit:i.countExceedNsLimit};case se.FETCH_METADATA_SUCCESS:{const s=i.metadata,n=s.path_lower&&S.isPointerByExtension(s.path_lower)?e.MODES.POINTER:t.uiMode;return{...t,uiMode:n,contentInfo:pe(t.contentInfo,s),fetchMetadataStatus:e.FETCH_METADATA_STATUS.SUCCESS}}case se.HANDLE_CONTENT_NAME_CHANGE:return{...t,contentNameInputValue:i.name,contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.INFO,contentNameMessage:""===i.name?de:void 0};case se.HANDLE_CONTENT_NAME_FOCUS_CHANGE:return{...t,isContentNameFocused:i.focus};case se.MEMBER_ACTION_COMPLETE:return{...t,pendingMemberAction:t.pendingMemberAction.delete(i.member.memberKey())};case se.MEMBER_ACTION_PENDING:return{...t,pendingMemberAction:t.pendingMemberAction.add(i.member.memberKey())};case se.REMOVE_MEMBER_KEEP_ACCESS:case se.REMOVE_MEMBER_SUCCESS:return{...t,pendingMemberAction:t.pendingMemberAction.delete(i.member.memberKey())};case se.SEND_SHARE_FAILURE:return{...t,uiMode:e.MODES.SHARE};case se.SEND_SHARE_REQUEST:return{...t,uiMode:e.MODES.SHARE_SENDING};case se.SEND_SHARE_SUCCESS:return{...t,uiMode:e.MODES.SHARE};case se.SHARE_FOLDER_SUCCESS:return{...t,contentInfo:pe(t.contentInfo,i.metadata)};case se.SHARE_MODAL_OPEN:{const s=i.shareModalInfoAttrs.contentInfo,n=i.shareModalInfoAttrs.inLinksPage,a=s.isFolder()&&!s.pathExists(),r=a&&!i.initialProps.initialContentName;let o,c=Se.uiMode;return S.isPointerByExtension(s.displayPath()||"")?c=e.MODES.POINTER:a?c=e.MODES.SHARE:n&&(c=e.MODES.LINK_ONLY,o=e.LINK_ONLY_REASON.LINKS_PAGE),{...t,contentInfo:s,linkOnlyReason:o,uiMode:c,contentNameInputValue:i.initialProps.initialContentName,contentNameMessage:r?de:"",initialProps:i.initialProps,initialRecipientTokens:i.shareModalInfoAttrs.initialRecipientTokens||[],isContentNameFocused:r,onCreateGroupCallback:i.initialProps.onCreateGroupCallback,recipientAccess:i.initialProps.defaultRecipientAccessLevel||void 0,recipientMessage:i.initialProps.recipientMessage||"",recipientTokens:[],recipientValidation:{},referrer:i.initialProps.referrer,experiments:i.initialProps.experiments,automationOptionChecked:i.initialProps.automationOptionChecked||!1,senderReminderVariant:i.initialProps.senderReminderVariant||!1}}case se.SHARE_MODAL_CLOSE:return{...t,initialRecipientTokens:i.tokens||t.initialRecipientTokens||[],backedOutOfNoDownloadExperiment:!1};case se.VALIDATE_CONTENT_NAME_ERROR:return{...t,contentNameMessage:i.errorMsg,contentNameMessageLevel:e.CONTENT_NAME_MESSAGE_LEVELS.ERROR};case se.VALIDATE_CONTENT_NAME_SUCCESS:return{...t,contentInfo:t.contentInfo.setFQPath(i.newFolderPath)};case se.TOGGLE_OPEN_AUTOMATIONS:return{...t,automationOptionChecked:!t.automationOptionChecked};case se.DOCSEND_ANALYTICS_LINK_REQUEST:return{...t,docsendAnalyticsLink:{status:"loading"}};case se.DOCSEND_ANALYTICS_LINK_SUCCESS:return{...t,docsendAnalyticsLink:{status:"ready",linkData:i.linkData}};case se.DOCSEND_ANALYTICS_LINK_FAILURE:return{...t,docsendAnalyticsLink:{status:"error"}};case se.DOCSEND_FILE_CONTEXT_REQUEST:return{...t,docSendFileContext:{status:"loading"}};case se.DOCSEND_FILE_CONTEXT_COMPLETE:return{...t,docSendFileContext:{status:"ready",data:i}};case se.NO_DOWNLOAD_EXIT:return{...t,backedOutOfNoDownloadExperiment:!0};case se.SETTINGS_TOOLTIP_CLOSE:return{...t,settingsTooltipHasBeenClosed:!0};default:return t}})(r.modalInfoState(),o),((e=me,t)=>{const n=t.payload;switch(t.type){case se.CHANGE_MEMBER_ACCESS_FAILURE:return{...e,members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.prevAccess)};case se.CHANGE_MEMBER_ACCESS_REQUEST:return{...e,members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.newAccess)};case se.CLEAR_FILE_MEMBERSHIP_LAST_SEEN_INFO:return{...e,members:e.members.update("users",(e=>e.map((e=>e.set("time_last_seen",null)))))};case se.CREATE_LINK_SUCCESS:return{...e,hasCreatedLink:!0,linkMetadata:n.linkMetadata,sharedLinks:e.sharedLinks.concat(n.linkMetadata)};case se.UPDATE_LINK_SUCCESS:return{...e,linkMetadata:n.linkMetadata,sharedLinks:e.sharedLinks.filter((e=>e.link_permissions.link_access_level!==n.linkMetadata.link_permissions.link_access_level)).concat(n.linkMetadata),selectedAudience:void 0};case se.FETCH_MEMBER_COUNTS_SUCCESS:return{...e,memberCounts:n.memberCounts};case se.FETCH_METADATA_FAILURE:return{...e,fetchingMetadataPromise:void 0};case se.FETCH_METADATA_REQUEST:return{...e,fetchingMetadataPromise:n.promise};case se.FETCH_METADATA_SUCCESS:return{...e,metadata:fe(e,n.metadata),fetchingMetadataPromise:void 0};case se.FETCH_SHARING_PREFS_REQUEST:return{...e,sharingPrefsFetchComplete:!1};case se.FETCH_SHARING_PREFS_SUCCESS:return{...e,areSharingPrefsLoaded:!0,sharingPrefsFetchComplete:!0,sharingPrefs:n.sharingPrefs};case se.FETCH_LINK_METADATA_FAILURE:return{...e,isLinkMetadataLoaded:!0,linkMetadata:void 0,sharedLinks:[]};case se.FETCH_LINK_METADATA_SUCCESS:return{...e,isLinkMetadataLoaded:!0,linkMetadata:n.sharedLinks.length>0?n.sharedLinks[0]:null,sharedLinks:n.sharedLinks,selectedAudience:void 0};case se.DELETE_LINK_METADATA_SUCCESS:{const t=[];for(const s of e.sharedLinks)s.url!==n.deletedLink.url&&t.push(s);return{...e,hasCreatedLink:!1,hasIncrementedUpsellCounter:!1,linkMetadata:t[0]?t[0]:null,sharedLinks:t}}case se.FETCH_USER_ACCOUNTS_REQUEST:return{...e,fetchingMembersRequest:{limitNonNull:n.limitNonNull,promise:n.promise,requestId:n.requestId}};case se.FETCH_USER_ACCOUNTS_SUCCESS:return e.fetchingMembersRequest&&e.fetchingMembersRequest.requestId!==n.requestId||e.hasDisplayableMembers&&e.fetchingMembersRequest&&e.fetchingMembersRequest.limitNonNull<e.members.getMemberCount()?e:{...e,hasDisplayableMembers:!0,areMembersFullyLoaded:!n.members.cursor,fetchingMembersRequest:n.members.cursor?e.fetchingMembersRequest:void 0,members:n.members};case se.FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS:return e.fetchingMembersRequest&&e.fetchingMembersRequest.requestId!==n.requestId?e:{...e,areMembersFullyLoaded:!n.members.cursor,fetchingMembersRequest:n.members.cursor?e.fetchingMembersRequest:void 0,members:e.members.mergeDeep(n.members)};case se.FETCH_CURRENT_ACCOUNT_REQUEST:return{...e,isCurrentAccountLoaded:!1};case se.FETCH_CURRENT_ACCOUNT_SUCCESS:return{...e,isCurrentAccountLoaded:!0,isFamilyUser:n.isFamilyUser,teamPolicy:n.teamPolicy,canUseExtendedSharingControls:n.canUseExtendedSharingControls,isPaired:n.isPaired};case se.FETCH_FILE_MEMBER_COUNT_SUCCESS:return{...e,memberCounts:new s.MemberCounts({total_unique_users:n.count,users_outside_team:0,exceeds_count:n.exceeds_limit})};case se.REMOVE_MEMBER_KEEP_ACCESS:return{...e,members:e.members.setIn([n.member.type(),n.member.memberKey(),"access_type"],n.access)};case se.REMOVE_MEMBER_SUCCESS:return{...e,members:e.members.deleteIn([n.member.type(),n.member.memberKey()])};case se.SHARE_FOLDER_FAILURE:return{...e,shareFolderPromise:void 0};case se.SHARE_FOLDER_REQUEST:return{...e,shareFolderPromise:n.promise};case se.SHARE_FOLDER_SUCCESS:return{...e,metadata:fe(e,n.metadata),shareFolderPromise:n.promise};case se.TRANSFER_OWNER_SUCCESS:return{...e,metadata:void 0,isLinkMetadataLoaded:!1,hasDisplayableMembers:!1};case se.UNBLOCK_MEMBER_LIST_ON_PASS_LOAD:return{...e,shouldBlockMemberListOnPassLoad:!1};case se.UPDATE_SHARING_SETTINGS_SUCCESS:return{...e,metadata:fe(e,n.metadata)};case se.SET_UPSELL_COUNTER_PREF_SUCCESS:return{...e,hasIncrementedUpsellCounter:!0};case se.CHANGE_LINK_AUDIENCE_SELECTION:return{...e,selectedAudience:n.audience};case se.SHARE_MODAL_OPEN:return{...e,selectedAudience:void 0};case se.DID_APPLY_BRANDING:return{...e,didApplyBranding:!0};default:return e}})(r.sharingInfoState(),o)),i.push(r.fqPath()),this.mapContentIdsToSharingInfo(n.id,i,r),r}}const Pe=new Ne;class Re{constructor(e){this.change_options=n.get(e,"change_options.allow",!1),this.edit_contents=n.get(e,"edit_contents.allow",!1),this.invite_editor=n.get(e,"invite_editor.allow",!1),this.invite_viewer=n.get(e,"invite_viewer.allow",!1),this.relinquish_membership=n.get(e,"relinquish_membership.allow",!1),this.leave_a_copy=n.get(e,"leave_a_copy.allow",!1),this.create_edit_link=n.get(e,"create_edit_link.allow"),this.create_view_link=n.get(e,"create_view_link.allow",!1),this.unshare=n.get(e,"unshare.allow",!1),this.update_confidentiality=n.get(e,"update_confidentiality.allow",!1),this.is_file_permissions=e instanceof s.FilePermissions,this.share_message_as_comment=n.get(e,"share_message_as_comment.allow",!1)}canChangeOptions(){return this.change_options}canEdit(){return this.edit_contents}canInviteEditor(){return this.invite_editor}canInviteViewer(){return this.invite_viewer}canInvite(){return this.canInviteViewer()||this.canInviteEditor()}canRelinquishMembership(){return this.relinquish_membership}canCreateEditLink(){return this.is_file_permissions&&this.create_edit_link}canCreateViewLink(){return this.is_file_permissions&&this.create_view_link}canUnshare(){return this.unshare}canUpdateConfidentiality(){return this.update_confidentiality}canLeaveACopy(){return this.leave_a_copy}canShareMessageAsComment(){return this.share_message_as_comment}}class Me{static createFromParams(e){return new Me(e)}constructor(e){this._user=e,this.setState(Se,me)}setState(e,t){this._modalInfo=e,this._sharingInfoState=t,t.metadata&&Pe.mapContentIdsToSharingInfo(this._user.id,Ie(t.metadata),this)}sharingInfoState(){return this._sharingInfoState}modalInfoState(){return this._modalInfo}user(){return this._user}hasDirectMemberSelf(){const e=this.members();if(e&&1===e.users.count()){return e.users.first().account_id===this._user.account_id}return!1}hasNonSelfMembers(){const e=this.members(),t=e&&e.getMemberCount();if(!t)return!1;if(1===t&&1===e.users.count()){return e.users.first().account_id!==this._user.account_id}return!0}hasNonOwnerMembers(){return this.hasNonSelfMembers()&&this.isOwner()}hasOutsideTeamMembers(){const e=this.memberCounts();return(e?e.users_outside_team:0)>0}memberNum(){const e=this.memberCounts(),t=this.members();return e&&e.total_unique_users?e.total_unique_users:t?t.getMemberCount():void 0}memberCountWithRecipients(){return(this.memberNum()||0)+s.getMemberCountForTokens(this.recipientTokens())}getInitialProps(){return this.modalInfoState().initialProps}areMembersFullyLoaded(){return this.sharingInfoState().areMembersFullyLoaded}areSharingPrefsLoaded(){return this.sharingInfoState().areSharingPrefsLoaded}sharingPrefsFetchComplete(){return this.sharingInfoState().sharingPrefsFetchComplete}setSharingPrefs(e){this._sharingInfoState.sharingPrefs=e}sharingPrefs(){return this.sharingInfoState().sharingPrefs}canShareLink(){return(!this.isConfidentialFolder()||this.isConfidentialFolderLinksEnabled())&&!s.isTeamFolderForNonTMRUser(this.isTeamSharedFolder(),this.user())&&!(this.isTeamSharedFolder()&&!this.sharingPrefs().tmr_tf_share_link_exp)&&this.contentInfo().pathExists()&&this.contentInfo().isMounted()}canDeleteLink(){const e=this.linkMetadata();return Boolean(e&&e.link_permissions.can_revoke)}contactsError(e){const t=this.recipientAccess();return s.validateContacts(e,this.recipientTokens(),this._user,this.recipientValidation()[t]||{},this.isTeamSharedFolder(),this.isFolderInsideTeamFolderTree(),this.memberCountWithRecipients())}contentId(){return this.contentInfo().id}contentInfo(){return this.modalInfoState().contentInfo}contentNameInputValue(){return this.modalInfoState().contentNameInputValue}contentNameMessage(){return this.modalInfoState().contentNameMessage}contentNameMessageLevel(){return this.modalInfoState().contentNameMessageLevel}displayPath(){const e=this.metadata();return this.contentInfo().displayPath()||e&&e.path_display||""}parentFolderName(){const e=this.metadata();if(e&&e instanceof s.SharedFileMetadata){const t=e.path_display;if(t){const e=t.split("/");if(e.length>1)return e[e.length-2]}}return e&&e instanceof s.SharedFolderMetadata&&e.parent_folder_name||""}fetchingMembersRequest(){return this.sharingInfoState().fetchingMembersRequest}fetchingMetadataPromise(){return this.sharingInfoState().fetchingMetadataPromise}filePolicy(){const e=this.metadata();return e&&e.file_policy}folderPolicy(){const e=this.metadata();return e&&e.policy}fqPath(){return this.contentInfo().displayPath()}hasDisplayableMembers(){return this.sharingInfoState().hasDisplayableMembers}hasParentSharedFolder(){const e=this.metadata();return!!e&&e.is_inside_team_folder}initialRecipientTokens(){return this.modalInfoState().initialRecipientTokens}isNonUserRelativeContext(){return this.getInitialProps().isInContentManager}isFolder(){return this.contentInfo().isFolder()}isConfidentialFolder(){const e=this.metadata();return Boolean(e&&e.is_confidential)}isContentNameFocused(){return this.modalInfoState().isContentNameFocused}isFolderInsideTeamFolderTree(){const e=this.metadata();return!!e&&e.is_inside_team_folder}isInsideSharedFolder(){const e=this.metadata();return Boolean(e&&e.parent_shared_folder_id||this.contentInfo().isInSharedFolder())}isLinkMetadataLoaded(){return this.sharingInfoState().isLinkMetadataLoaded}isMetadataLoaded(){return Boolean(this.metadata())}isOwner(){const e=this.metadata();return Boolean(e&&e.access_type===s.ACCESS_LEVEL.OWNER)}isOSXPackage(){const e=this.displayPath(),t=e.substr(e.lastIndexOf("."));return s.PACKAGE_EXTS.indexOf(t)>=0}isConfidentialFolderLinksEnabled(){return this.sharingPrefs().confidential_folder_links_enabled}isShareModalUpsellPremiumSharing(){return this.sharingPrefs().in_share_modal_upsell_premium_sharing}shareModalUpsellPremiumSharingVariant(){return this.sharingPrefs().in_share_modal_upsell_premium_sharing_variant}hasSeenUpsellCounter(){return this.sharingPrefs().has_seen_share_modal_upsell_premium_sharing_counter}hasCreatedLink(){return this.sharingInfoState().hasCreatedLink}hasIncrementedUpsellCounter(){return this.sharingInfoState().hasIncrementedUpsellCounter}inviteAfterSharingModalVariant(){return this.sharingPrefs().invite_after_sharing_modal_variant}getExperiments(){return this.modalInfoState().experiments}hasSeenEsignPostSharing(){return this.sharingPrefs().has_seen_esign_post_sharing}isInEsignPostSharingExclusionPeriod(){return this.sharingPrefs().is_in_esign_post_sharing_exclusion_period}isShowingFileUploadToolkitCampaign(){return this.sharingPrefs().is_showing_file_upload_toolkit_campaign}getReferrer(){return this.modalInfoState().referrer}isUserOnOwnerTeam(){const e=this.metadata();return Boolean(e&&e.owner_team&&e.owner_team.id===this._user.team_dbtid)}isCurrentAccountLoaded(){return this.sharingInfoState().isCurrentAccountLoaded}isTeamSharedFolder(){const e=this.metadata();return Boolean(e&&e.is_team_folder||this.contentInfo().isTeamSharedFolder())}isTokenizerEmpty(){return 0===this.recipientRawInput().length&&0===this.recipientTokens().length}linkMetadata(){return this.sharingInfoState().linkMetadata}sharedLinks(){return this.sharingInfoState().sharedLinks||[]}shmodelLink(){return this.sharedLinks().filter((e=>!e.isRighteousLink()))[0]}editRighteousLink(){return this.sharedLinks().filter((e=>"editor"===e.link_permissions.link_access_level))[0]}viewRighteousLink(){return this.sharedLinks().filter((e=>"viewer"===e.link_permissions.link_access_level))[0]}linkOnlyReason(){return this.modalInfoState().linkOnlyReason}countsExceedNsLimit(){return this.modalInfoState().countsExceedNsLimit}memberCounts(){return this.sharingInfoState().memberCounts}members(){return this.sharingInfoState().members}metadata(){return this.sharingInfoState().metadata}name(){const e=this.contentInfo(),t=this.metadata();return e&&e.name()||t&&t.name||""}ownerTeam(){const e=this.metadata();return e&&e.owner_team}ownerTeamPolicy(){const e=this.metadata();return e&&e.owner_team_policies}parentSharedFolderId(){const e=this.metadata();return e&&e.parent_shared_folder_id}pendingMemberAction(){return this.modalInfoState().pendingMemberAction}permissionsObj(){return new Re(this.permissions())}permissions(){const e=this.metadata();return e&&e.permissions}recipientAccess(){const e=this.modalInfoState();if(e.recipientAccess)return e.recipientAccess;{const e=this.permissionsObj().canInviteEditor()||this.permissionsObj().canCreateEditLink(),t=this.getDefaultSharingAccessLevel();if(t){const n=t===s.ACCESS_LEVEL.WRITER,i=t===s.ACCESS_LEVEL.READER;if(n&&e||i)return t}return e||this.editRighteousLink()?s.ACCESS_LEVEL.WRITER:s.ACCESS_LEVEL.READER}}recipientMessage(){return this.modalInfoState().recipientMessage}onCreateGroupCallback(){return this.modalInfoState().onCreateGroupCallback}recipientRawInput(){return this.modalInfoState().recipientRawInput}recipientTokens(){return this.modalInfoState().recipientTokens}recipientValidation(){return this.modalInfoState().recipientValidation}shareAsConfidential(){return Boolean(this.getInitialProps().shareAsConfidential)}shareFolderPromise(){return this.sharingInfoState().shareFolderPromise}shouldBlockMemberListOnPassLoad(){return this.sharingInfoState().shouldBlockMemberListOnPassLoad}shouldSyncThisFolder(){return this.getInitialProps()?this.getInitialProps().shouldSyncThisFolder:null}isEncryptedFolder(){const e=this.metadata();return Boolean(null==e?void 0:e.is_encrypted)}shouldEncryptThisFolder(){return!!this.getInitialProps()&&this.getInitialProps().shouldEncryptThisFolder}teamPolicy(){return this.sharingInfoState().teamPolicy}isFamilyUser(){return this.sharingInfoState().isFamilyUser}canUseExtendedSharingControls(){return this.sharingInfoState().canUseExtendedSharingControls}isPaired(){return this.sharingInfoState().isPaired}uiMode(){return this.modalInfoState().uiMode}isCloudDoc(){const e=this.metadata();return!(!e||!e.is_cloud_doc)}isCloudEnhancedFile(){const e=this.name();if(e){const t=(e.substring(e.lastIndexOf(".")||e.length,e.length)||"").toLowerCase();return".docx"===t||".doc"===t||".pptx"===t||".ppt"===t||".xlsx"===t||".xls"===t}return!1}fetchMetadataStatus(){return this.modalInfoState().fetchMetadataStatus}isUserEligibleForEssFreeTrial(){return this.sharingPrefs().is_user_eligible_for_essential_free_trial}getSharingUpsellV2Variant(){return this.sharingPrefs().sharing_upsell_kiwi_pie_v2_variant}shouldShowUpsellExperience(){return(t=>[e.EXP_UPSELL_KIWI_PIE_VARIANT.M2V1,e.EXP_UPSELL_KIWI_PIE_VARIANT.M2P2_CONTROL,e.EXP_UPSELL_KIWI_PIE_VARIANT.M2_GREEN_PREMIUM,e.EXP_UPSELL_KIWI_PIE_VARIANT.M2_GOLD_PREMIUM].includes(t))(this.getSharingUpsellV2Variant())}shouldAutoShowLinkSettingsTooltip(){return this.sharingPrefs().should_auto_show_link_settings_tooltip&&this.shouldShowUpsellExperience()}isShareMessageAsCommentChecked(){const e=this.modalInfoState().isShareMessageAsCommentExplicitlyChecked;return void 0===e?this.permissionsObj().canShareMessageAsComment():e}shouldSuppressRedirectToBrowse(){return this.getInitialProps()?this.getInitialProps().shouldSuppressRedirectToBrowse:null}getBrowseOnboardaingPathway(){return this.getInitialProps()?this.getInitialProps().browseOnboardingPathway:null}shouldCloseImmediately(){return this.getInitialProps()?this.getInitialProps().shouldCloseImmediately:null}shouldFetchLinkMetadata(){return this.canShareLink()&&!this.isNonUserRelativeContext()&&this.contentInfo().isMounted()}getSelectedAudience(){return this.sharingInfoState().selectedAudience}getEligibleInviteAfterSharingContacts(){return((e,t)=>{const s=new Set(e.filter((e=>!e.invalid)).map((e=>e.getKey()))),n=Object.values(t),i=new Set,a=new Set,r=new Set;for(const e of n)for(const t in e)if(e.hasOwnProperty(t)&&s.has(t)){const s=e[t];if(s&&s.inviteAfterSharingEligibility){const e=s.inviteAfterSharingEligibility[".tag"];"eligible_not_seen"===e?i.add(t):"eligible_seen"===e?a.add(t):"eligible_seen_resurface"===e&&r.add(t)}}return{inviteEligibleNotSeenContacts:e.filter((e=>i.has(e.getKey())&&!e.invalid)),inviteEligibleSeenContacts:e.filter((e=>a.has(e.getKey())&&!e.invalid)),inviteEligibleSeenResurfaceContacts:e.filter((e=>r.has(e.getKey())&&!e.invalid))}})(this.recipientTokens(),this.recipientValidation())}automationOptionChecked(){return this.modalInfoState().automationOptionChecked}isExpBsxOrganizeAroundPeopleEnabled(){return this.sharingPrefs().bsx_organize_around_people}isNoDownloadOnShareEnabled(){return this.sharingPrefs().no_download_on_share_validation_experiment}isNoDownloadOnShareValid(){return!this.isCloudDoc()&&!(this.viewRighteousLink()||this.shmodelLink())}isCreateViewFileLinkEnabled(){return this.sharingPrefs().create_view_file_link_enabled}isCreateViewFolderLinkEnabled(){return this.sharingPrefs().create_view_folder_link_enabled}willRLBeCreated(e){return this.isFolder()?"editor"===e||this.isCreateViewFolderLinkEnabled():this.isCloudDoc()?!this.isCloudEnhancedFile()||("editor"===e||this.isCreateViewFileLinkEnabled()):"viewer"===e&&this.isCreateViewFileLinkEnabled()}getTeamDefaultSharingAccessLevel(){var e;const t=s.DEFAULT_SHARING_ACCESS_LEVEL[null===(e=this.teamPolicy())||void 0===e?void 0:e.shared_link_default_permissions_policy];if(t!==s.SharingAccessLevel.UNKNOWN)return t}getDefaultSharingAccessLevel(){const e=this.getTeamDefaultSharingAccessLevel();if(e)return e;const t=this.sharingPrefs().default_sharing_access_level_setting?s.DEFAULT_SHARING_ACCESS_LEVEL[this.sharingPrefs().default_sharing_access_level_setting[".tag"]]:s.ACCESS_LEVEL.WRITER;return t===s.SharingAccessLevel.UNKNOWN?s.ACCESS_LEVEL.WRITER:t}getDefaultSharingLinkAudience(){const e=this.sharingPrefs().default_sharing_link_audience_setting?this.sharingPrefs().default_sharing_link_audience_setting[".tag"]:Ce;return e===s.SharingLinkAudience.UNKNOWN?Ce:e}getLastSeenTeamPolicyAudience(){const e=this.sharingPrefs().last_seen_team_policy_audience?this.sharingPrefs().last_seen_team_policy_audience[".tag"]:Ce;return e===s.SharingLinkAudience.UNKNOWN?Ce:e}isReplayInShareModalEnabled(){return this.sharingPrefs().is_replay_in_share_modal_enabled}isFromFlexibleSharingEntrypoint(){return Boolean(this.getInitialProps().isFromFlexibleSharingEntrypoint)}addBrandingButtonVisible(){return this.sharingPrefs().editing_customize_branding}didApplyBranding(){return this.sharingInfoState().didApplyBranding}lowDistractionViewEnabled({ensureIsViewLink:e=!0}={}){return!!this._lowDistractionViewAllowed(e)&&(s.logExposure({feature:"pro_sharing_presentation_links",variant:this.sharingPrefs().low_distraction_view_variant}),this.sharingPrefs().low_distraction_view_enabled)}isLowDistractionViewControlVariant(){return"CONTROL"===this.sharingPrefs().low_distraction_view_variant&&this._lowDistractionViewAllowed()}_lowDistractionViewAllowed(e=!0){if(e){const e=this.viewRighteousLink();if(!e||e.isFolder())return!1}return p.isLowDistractionViewAvailableForFile(this.name())}isSendReminder(){return ge(this.modalInfoState().senderReminderVariant)}loggedOutCommentingEnabled(){return this.sharingPrefs().logged_out_commenting_enabled}}const Le={loadFileMetadataBatch:(e,t)=>new s.FileShareApiClient({userApiProps:e}).getMetadataBatchAlpha({contentIds:t,actions:Object.keys(s.ALPHA_FILE_METADATA_PERMISSIONS)}).then((t=>i.dispatcherSingleton.dispatch({type:ne.FETCH_METADATA_BATCH_SUCCESS,user:e,data:t}))),loadFileMetadata:({user:e,contentId:t,sourceUrl:n,client:a})=>{const r=Pe.getSharingInfo(e.id,t);if(r&&r.fetchingMetadataPromise())return r.fetchingMetadataPromise();const o=(a=a||new s.FileShareApiClient({userApiProps:e})).getMetadataAlpha({contentId:t,actions:Object.keys(s.ALPHA_FILE_METADATA_PERMISSIONS),sourceURL:n}).then((t=>{i.dispatcherSingleton.dispatch({type:ne.FETCH_METADATA_BATCH_SUCCESS,user:e,data:[t]})}));return i.dispatcherSingleton.dispatch({type:se.FETCH_METADATA_REQUEST,contentIds:[t],data:{promise:o},user:e}),o},listMembers:({user:e,contentId:t,isFolder:n,limit:a,url:r,members:o,client:c,includeSeenState:_=!0,passSessionId:l,isNonUserRelativeContext:d=!1,isPassPrefetch:h=!1})=>{u.assert(!a||a<=100,"listMembers not implemented for limit > 100");const E=a||9999999,S=Pe.getSharingInfo(e.id,t);if(S){const e=S.fetchingMembersRequest();if(e&&E<=e.limitNonNull)return e.promise;if(S.hasDisplayableMembers()&&E<S.members().getMemberCount())return Promise.resolve({})}const p=Math.random().toString(),m=!n;c||(c=n?d?new s.FolderShareApiClient({userApiProps:e,isNonUserRelativeContext:d,teamMemberId:e.team_member_id}):new s.FolderShareApiClient({userApiProps:e}):d?new s.FileShareApiClient({userApiProps:e,isNonUserRelativeContext:d,teamMemberId:e.team_member_id}):new s.FileShareApiClient({userApiProps:e}));const f=s=>s?(i.dispatcherSingleton.dispatch({type:se.FETCH_USER_ACCOUNTS_CONTINUED_REQUEST,contentIds:[t],user:e}),c.listMembersContinue({cursor:s,url:r,isAlpha:m}).then((s=>{i.dispatcherSingleton.dispatch({type:se.FETCH_USER_ACCOUNTS_CONTINUED_SUCCESS,contentIds:[t],data:{members:s,requestId:p},user:e}),f(s.cursor)}))):Promise.resolve({});let I;return l&&V.record(s.LoggingActions.LIST_MEMBERS_BEGIN,l),I=o?Promise.resolve(o):c.listMembers({contentId:t,url:r,limit:a,isAlpha:m,includeSeenState:_,isPassPrefetch:h}),I=I.then((n=>{l&&V.record(s.LoggingActions.LIST_MEMBERS_RECEIVE,l),i.dispatcherSingleton.dispatch({type:se.FETCH_USER_ACCOUNTS_SUCCESS,contentIds:[t],data:{members:n,requestId:p},user:e}),a||f(n.cursor)})),i.dispatcherSingleton.dispatch({type:se.FETCH_USER_ACCOUNTS_REQUEST,contentIds:[t],data:{limitNonNull:E,requestId:p,promise:I},user:e}),I},fetchFileMemberCount:({user:e,contentId:t,limit:n,url:a,client:r,countGroupsAsMembers:o=!1,passSessionId:c,runViewerInfoChecks:_=!1,isPassPrefetch:l=!1})=>{r=r||new s.FileShareApiClient({userApiProps:e}),c&&V.record(s.LoggingActions.MEMBER_COUNTS_BEGIN,c);const d=r.getMemberCounts({contentId:t,limit:n,url:a,countGroupsAsMembers:o,runViewerInfoChecks:_,isPassPrefetch:l});return i.dispatcherSingleton.dispatch({type:se.FETCH_FILE_MEMBER_COUNT_REQUEST,contentIds:[t],user:e}),d.then((n=>{c&&V.record(s.LoggingActions.MEMBER_COUNTS_RECEIVE,c),i.dispatcherSingleton.dispatch({type:se.FETCH_FILE_MEMBER_COUNT_SUCCESS,contentIds:[t],data:n,user:e})}))},fetchFolderMemberCount:({user:e,contentInfo:t,client:s})=>{const n=t.id,a=t.isSharedFolder()?t.sharedFolderId():t.nsId();return i.dispatcherSingleton.dispatch({type:se.FETCH_MEMBER_COUNTS_REQUEST,data:{},contentIds:[n],user:e}),s.getMemberCounts({contentId:a}).then((t=>{i.dispatcherSingleton.dispatch({type:se.FETCH_MEMBER_COUNTS_SUCCESS,data:{memberCounts:t},contentIds:[n],user:e})}))}};class Fe{static setup({viewer:e,user:t,fileData:s,prevFileData:n,passSessionId:i,shouldWritePresence:a=!0,skipListMembers:r=!1,limit:o=150,maxMembersSizeLimit:c=6,isFileViewer:_}){const l=s.file.file_id;this.shouldInitializePass(t,l,a)&&(k.passPermissionRequest(l),Fe.makeAllRequests({viewer:e,user:t,fileData:s,prevFileData:n,passSessionId:i,shouldWritePresence:a,skipListMembers:r,limit:o,maxMembersSizeLimit:c,isFileViewer:_}))}static teardown({viewer:e,user:t,fileData:s,async:n,shouldWritePresence:i=!0}){const{file:a,url:r}=s,o=a.file_id;if(this.shouldInitializePass(t,o,i)){Fe.removeUnloadHandler();const s=new te(o,r);j.shutdown({viewer:e,beaconFileData:s,user:t,async:n,shouldWritePresence:i})}}static shouldInitializePass(e,t,s){return(null!==e||s)&&t}static onBeaconUpdate(e,t,s){const n=s.fileId;"delta"===e.type?k.receivePresenceDelta(t,n,e.onlineUniqueUsers,e.offlineUniqueUsers):"snapshot"===e.type&&k.receivePresenceSnapshot(t,n,e.onlineUniqueUsers)}static makeAllRequests({viewer:e,user:t,fileData:s,prevFileData:n,passSessionId:i,limit:a=150,shouldWritePresence:r=!0,skipListMembers:o=!1,maxMembersSizeLimit:c,isFileViewer:_}){const{file:l,url:d}=s,{file_id:u,fq_path:h}=l,E=u||h,S=new te(l.file_id,d);t?(E&&!o&&Le.listMembers({user:t,contentId:E,isFolder:!1,limit:c,url:d,passSessionId:i,includeSeenState:!1,isPassPrefetch:_}),W.fetchSeenStateInfo(t,u,a,d,i),j.receiveBeaconData({beaconFileData:S,user:t,passSessionId:i,onUpdate:this.onBeaconUpdate})):k.updatePermissions(u,{canReadPresence:!1,canReadSeenState:!1});const p=e.is_assume_user_session;if(!r||p)k.updatePermissions(u,{canWritePresence:!1});else{const a=n&&new te(n.file,n.url);j.transmitBeaconData({user:t,passSessionId:i,beaconFileData:S,prevBeaconFileData:a}),Fe.removeUnloadHandler(),Fe.onUnload=n=>(this.teardown({viewer:e,user:t,fileData:s,async:!1,shouldWritePresence:!0}),n.returnValue=void 0,null),document.addEventListener("beforeunload",Fe.onUnload)}}}Fe.removeUnloadHandler=()=>{Fe.onUnload&&document.removeEventListener("beforeunload",Fe.onUnload),Fe.onUnload=void 0};const Ue=l.intl.formatMessage({id:"kLqbNF",defaultMessage:"Open now"}),Oe=l.intl.formatMessage({id:"DcMHbT",defaultMessage:"Shared with"}),be=l.intl.formatMessage({id:"L0u1G7",defaultMessage:"Hasnt opened"}),we=(e,t)=>e.isActive?Ue:null!=e.whenLastSeen?(e=>{const t=s.ago(e,!1);return l.intl.formatMessage({id:"GJHL3E",defaultMessage:"Opened {timeAgo}"},{timeAgo:t})})(new Date(1e3*e.whenLastSeen)):t?be:Oe,ye=l.intl.formatMessage({id:"h5b9Ud",defaultMessage:"Who can access"}),De=({isPassPermissionsPending:e})=>{const t=s.cx(s.FACEPILE_CLASSNAME,s.EMPTY_FACEPILE_CLASSNAME,{[s.PRESENCE_RECEIVED_CLASSNAME]:!e});return I.default.createElement("div",{className:t})};De.displayName="EmptyFacepile";class ve extends I.default.Component{constructor(){super(...arguments),this.state={newPresentUserIds:[]},this.onAvatarClick=e=>{var t;o.isSupportedMobileBrowser()||m.share(this.props.file,this.props.viewer.get_user_by_id(this.props.user.id),this.props.url||null,{origin:s.SHARE_ACTION_ORIGIN_TYPE.PREVIEW_PAGE_FACEPILE,initialScreen:s.MANAGE_SCREEN,selectedMemberId:null!==(t=null==e?void 0:e.userId)&&void 0!==t?t:null==e?void 0:e.email})},this.canShowPASS=()=>{const{isPassPermissionsPending:e,passFetchingStatus:t,passPermissions:n}=this.props;return!e&&t!==s.PassFetchingStatus.ERROR&&null!==n&&(n.canReadPresence||n.canReadSeenState)},this.canShowMembershipInfo=()=>{const{sharingStorePassInfo:e}=this.props;return e.isLoaded&&null!==e.data&&e.data.users.length>0}}UNSAFE_componentWillReceiveProps(e){if(s.areFilesEqual(this.props.file,e.file)){if(!e.presence||!this.props.presence)return;const t=e.presence.filter((e=>{var t;return!(null===(t=this.props.presence)||void 0===t?void 0:t.includes(e))})),s=this.props.presence.filter((t=>{var s;return!(null===(s=e.presence)||void 0===s?void 0:s.includes(t))}));this.updateNewPresentUserIds(t,s)}else this.setState({newPresentUserIds:[]})}updateNewPresentUserIds(e,t){const s=this.state.newPresentUserIds.filter((e=>!t.includes(e)));this.setState({newPresentUserIds:[...e,...s]})}userIsAnonymous(e){for(const t of this.props.anonymousPresenceInfo)if(t.seen_state_user.user_id===e.user_id)return!0;return!1}userIsOnline(e){return null!=this.props.presence&&this.props.presence.includes(e.user_id)}buildUserInfo(e){const t=e.seen_state_user.user_id||e.seen_state_user.display_name,s=this.userIsAnonymous(e.seen_state_user);return new Z(t,e.seen_state_user.display_name,this.userIsOnline(e.seen_state_user),e.seen_state_user.email||e.seen_state_user.display_name,e.when_last_seen,e.seen_state_user.photo_circle_url,e.seen_state_user.user_id,e.seen_state_user.same_team,s)}partitionUserInfoLists(e){const t=[],s=[],n=[],i=[],a=[],r={};for(const t of e){const e=this.buildUserInfo(t);this.userIsOnline(t.seen_state_user)?this.isNewPresentUser(e)?r[e.key]=e:this.userIsAnonymous(t.seen_state_user)?n.push(e):s.push(e):null!=t.when_last_seen?i.push(e):a.push(e)}for(const e of this.state.newPresentUserIds){const s=r[e];s&&t.push(s)}return{newPresentUserInfoList:t,presentUserInfoList:s,anonymousUserInfoList:n,offlineUserInfoList:i,neverViewedUserInfoList:a}}getUserInfoList(){const e=[];let t=this.getMergedSeenStateData();if(this.shouldHardcodeCurrentViewer()){t=t.filter((e=>e.seen_state_user.user_id!==this.props.user.account_id));const s=this.props.viewer.get_user_by_id(this.props.user.id);e.push(new Z(this.props.user.account_id,s.display_name,this.canShowPASS(),s.email,void 0,s.photo_url,this.props.user.account_id,!0,!1))}const s=this.partitionUserInfoLists(t),{newPresentUserInfoList:n,presentUserInfoList:i,anonymousUserInfoList:a,offlineUserInfoList:r,neverViewedUserInfoList:o}=s;return i.sort(((e,t)=>e.displayName.toLowerCase().localeCompare(t.displayName.toLowerCase()))),o.sort(((e,t)=>e.displayName.toLowerCase().localeCompare(t.displayName.toLowerCase()))),[...e,...n,...i,...a,...r,...o]}isNewPresentUser(e){return this.state.newPresentUserIds.indexOf(e.key)>=0}getMergedSeenStateData(){const e=this.getSeenStates(),t=e.map((e=>e.seen_state_user.user_id));if(this.props.sharingStorePassInfo.data){for(const s of this.props.sharingStorePassInfo.data.users){const n=s.seen_state_user.user_id;-1!==t.indexOf(n)||n===this.props.user.account_id&&this.shouldHardcodeCurrentViewer()||e.push(s)}return[...e,...this.props.anonymousPresenceInfo,...this.props.sharingStorePassInfo.data.invitees]}return[...e,...this.props.anonymousPresenceInfo]}shouldHardcodeCurrentViewer(){const e=!this.props.viewer.is_assume_user_session,t=null!=this.props.presence&&this.props.presence.indexOf(this.props.user.account_id)>=0;return e||t}getSeenStates(){return this.props.identifiedSeenStateInfo&&this.props.identifiedSeenStateInfo.seen_states?[...this.props.identifiedSeenStateInfo.seen_states]:[]}haveSeenStateDataToShow(e){return e.length>0}dataSufficientForDisplayHasLoaded(){return this.props.sharingStorePassInfo.isLoaded&&s.fetchingStatusSeenStateIsComplete(this.props.passFetchingStatus)}render(){var e;if(!this.canShowPASS()&&!this.canShowMembershipInfo())return I.default.createElement(De,{isPassPermissionsPending:this.props.isPassPermissionsPending});if(!this.dataSufficientForDisplayHasLoaded())return I.default.createElement("div",null);const t=this.getUserInfoList();return this.haveSeenStateDataToShow(t)?I.default.createElement("div",{className:this.facepileClassName()},I.default.createElement(s.Facepile,{"aria-label":l.intl.formatMessage({id:"6Caba5",defaultMessage:"Shared with"}),size:"medium"},this.computeFacepileItems(t,!0===(null===(e=this.props.passPermissions)||void 0===e?void 0:e.canReadSeenState)))):I.default.createElement(De,{isPassPermissionsPending:this.props.isPassPermissionsPending})}facepileClassName(){return s.cx(s.FACEPILE_CLASSNAME,{[s.PRESENCE_RECEIVED_CLASSNAME]:!this.props.isPassPermissionsPending})}getInitialsForUserInfo(e){return e.userId&&s.AnonymousViewerUtils.isAnonymousUserId(e.userId)?s.AnonymousViewerUtils.getAnonymousViewerInitials(e.displayName):s.getInitials(e.displayName)}computeFacepileItems(e,t){const n=[],i=this.props.onlyShowOverflow?1:s.MAX_FACEPILE_ITEMS-1;return n.push(...e.slice(0,i).map((e=>{const{isActive:n,displayName:i,key:a,photoUrl:r,isGuest:o,sameTeam:c}=e,_=o||!c?I.default.createElement(s.Facepile.Item,{isGuest:!0,isInactive:!n,alt:i,onClick:()=>this.onAvatarClick(e),cursor:"pointer","data-testid":"user-item"}):I.default.createElement(s.Facepile.Item,{src:r,isInactive:!n,alt:i,onClick:()=>this.onAvatarClick(e),cursor:"pointer","data-testid":"user-item"},this.getInitialsForUserInfo(e)),l=I.default.createElement(s.Box,{display:"flex",flexDirection:"column",alignItems:"center"},I.default.createElement(s.Text,{isBold:!0},i),I.default.createElement(s.Text,{color:"faint",size:"small"},we(e,t)));return I.default.createElement(s.Tooltip,{title:l,key:a},_)}))),n.push(I.default.createElement(s.Tooltip,{title:I.default.createElement(s.Text,{isBold:!0},ye),key:"overflow"},I.default.createElement(s.Facepile.Item,{alt:ye,colorPalette:{background:"var(--dig-color__opacity__surface)",foreground:"var(--dig-color__text__base)"},onClick:()=>this.onAvatarClick(),cursor:"pointer","data-testid":"who-can-access-item"},I.default.createElement(s.UIIcon,{src:s.PersonMultipleLine,role:"presentation"})))),n}}ve.contextTypes={logEvent:s.PropTypes.func,performanceTimer:s.PropTypes.func,reportError:s.PropTypes.func},ve.displayName="SeenStateFacepile";class ke extends I.default.Component{constructor(e){super(e),this.onUpdateFromStore=()=>{this.setState(this.getStateFromStore())},this.state=this.getStateFromStore(),this.passSessionId=e.passSessionId||c.v4()}UNSAFE_componentWillMount(){const{featureConfig:e,viewer:t,user:s}=this.props,n=o.isSupportedMobileBrowser()&&e&&a.isMobileRedesignEnabled(e);J.add_change_listener(this.onUpdateFromStore),Pe.add_change_listener(this.onUpdateFromStore),Fe.setup({viewer:t,user:s,passSessionId:this.passSessionId,fileData:this.getPassFileData(),skipListMembers:!1,prevFileData:null,maxMembersSizeLimit:n?100:3,isFileViewer:!0})}UNSAFE_componentWillReceiveProps(e){s.areFilesEqual(e.file,this.props.file)||this.setState({passInfo:{anonymousPresence:null,isPassPermissionsPending:!0,passFetchingStatus:s.PassFetchingStatus.FETCHING,passPermissions:null,presence:null,identifiedSeenStateInfo:null,userIdsWithoutSeenStateInfo:[]},sharingInfo:void 0})}UNSAFE_componentWillUpdate(e,t){const n=t.passInfo;if(n.userIdsWithoutSeenStateInfo.length>0&&s.fetchingStatusIsSuccessful(n.passFetchingStatus)&&e.user){const t=e.file,s=this.urlFromProps(e);W.fetchSeenStateUsers(e.user,n.identifiedSeenStateInfo,n.userIdsWithoutSeenStateInfo,t.file_id,s,this.passSessionId)}}componentDidUpdate(e){if(!s.areFilesEqual(this.props.file,e.file)){const t={file:e.file,url:this.urlFromProps(e)},s=o.isSupportedMobileBrowser()&&this.props.featureConfig&&a.isMobileRedesignEnabled(this.props.featureConfig);this.passSessionId=c.v4(),Fe.setup({viewer:this.props.viewer,user:this.props.user,passSessionId:this.passSessionId,fileData:this.getPassFileData(),skipListMembers:!1,prevFileData:t,maxMembersSizeLimit:s?100:3,isFileViewer:!0})}}componentWillUnmount(){J.remove_change_listener(this.onUpdateFromStore),Pe.remove_change_listener(this.onUpdateFromStore),Fe.teardown({viewer:this.props.viewer,user:this.props.user,fileData:this.getPassFileData(),async:!0})}getStateFromStore(){const{user:e,file:{file_id:t}}=this.props;return{passInfo:{anonymousPresence:J.anonymousPresence(t),isPassPermissionsPending:J.isPassPermissionsPending(t),passFetchingStatus:J.passFetchingStatus(t),passPermissions:J.getPassPermissions(t),presence:J.presence(t),identifiedSeenStateInfo:J.identifiedSeenStateInfo(t),userIdsWithoutSeenStateInfo:J.userIdsWithoutSeenStateInfo(t)},sharingInfo:e&&Pe.getSharingInfo(e.id,t)||void 0}}getAnonymousPassInfo(){return null==this.state.passInfo.anonymousPresence?[]:this.state.passInfo.anonymousPresence.map((function(e){return{seen_state_user:{user_id:e,display_name:l.intl.formatMessage({id:"+s6D7j",defaultMessage:"Guest"})},seen_events:[]}}))}getMemberInfosInPassFormat(e){const t=e.members();return{invitees:t?this.getInviteeMemberInfos(t):[],users:t?this.getUserMemberInfos(t):[]}}getUserMemberInfos(e){return e.users.valueSeq().toArray().reduce((function(e,t){return t.account&&e.push({seen_state_user:{user_id:t.account_id,display_name:t.account.display_name,email:t.email(),photo_circle_url:t.account.profile_photo_url||void 0,access_level:t.access_type,same_team:t.same_team},seen_events:[]}),e}),[])}getInviteeMemberInfos(e){return e.invitees.valueSeq().toArray().map((function(e){return{seen_state_user:{display_name:e.contact,access_level:e.access_type},seen_events:[]}}))}getPassFileData(){return{file:this.props.file,url:this.urlFromProps()}}urlFromProps(e=this.props){return e.sharedLinkInfo?e.sharedLinkInfo.url:void 0}getPropsFromPassInfo(){return{anonymousPresenceInfo:this.getAnonymousPassInfo(),isPassPermissionsPending:this.state.passInfo.isPassPermissionsPending,passFetchingStatus:this.state.passInfo.passFetchingStatus,passPermissions:this.state.passInfo.passPermissions,presence:this.state.passInfo.presence,identifiedSeenStateInfo:this.state.passInfo.identifiedSeenStateInfo}}getPropsFromSharingInfo(){const e={sharingStorePassInfo:ee.createNotLoaded()};return this.state.sharingInfo?(this.state.sharingInfo.hasDisplayableMembers()&&(e.sharingStorePassInfo=ee.create(this.getMemberInfosInPassFormat(this.state.sharingInfo))),e):e}render(){const{user:e,onlyShowOverflow:t,file:s}=this.props,n=this.getPropsFromPassInfo();return null==e?I.default.createElement(De,{isPassPermissionsPending:!n.isPassPermissionsPending}):I.default.createElement(ve,{...n,...this.getPropsFromSharingInfo(),file:s,url:this.urlFromProps(),viewer:this.props.viewer,user:e,onlyShowOverflow:t})}}ke.displayName="_SeenStateFacepileController";const He=_.withViewer(ke),Ve=({activePreviewFile:e,enablePassUi:t,passSessionId:n,user:i,onlyShowOverflow:a})=>{var r;const{featureConfig:o}=s.useFileViewerContext(),c=e.file.file_id,_=null===(r=e.sharedLinkInfo)||void 0===r?void 0:r.url,l=null!=i?i:null;return I.useEffect((()=>(j.transmitBeaconData({prevBeaconFileData:null,beaconFileData:new te(c,_),user:l,passSessionId:void 0}),()=>j.shutdown({viewer:s.DeprecatedViewer.get_viewer(),beaconFileData:new te(c,_),user:l,async:!0}))),[l,c,_,o]),t?I.createElement("div",{className:"_pass_1wgu7_1","data-testid":"pass"},I.createElement(He,{user:i||null,file:e.file,passSessionId:n,sharedLinkInfo:e.sharedLinkInfo,onlyShowOverflow:a,featureConfig:o})):null};Ve.displayName="TitleBarPassUi";var xe=Object.freeze({__proto__:null,TitleBarPassUi:Ve});e.GetSeenStateRoutes=v,e.PassActions=k,e.PassHelpers=Fe,e.RequestedVisibilityPolicy={policy_name:"requested_visibility",password:"password",public:"public",team_only:"team_only"},e.ResolvedVisibilityPolicy={policy_name:"resolved_visibility",only_you:"only_you",password:"password",public:"public",shared_folder_only:"shared_folder_only",team_and_password:"team_and_password",team_only:"team_only",no_one:"no_one"},e.ShareModalActionTypes=se,e.SharingActions=Le,e.TitleBarPassUi=Ve,e.getContentIdsForContentInfo=e=>{const t=[];return e.isSharedFolder()?t.push(e.sharedFolderId()):(e.extras.fileId&&t.push(e.extras.fileId),e.extras.nsId&&e.extras.nsPath&&t.push(`ns:${e.nsId()}${e.nsPath()}`)),e.displayPath()&&t.push(e.displayPath()),t},e.isInExpUpsellKiwiPieM2ColorChanges=t=>t===e.EXP_UPSELL_KIWI_PIE_VARIANT.M2_GOLD_PREMIUM||t===e.EXP_UPSELL_KIWI_PIE_VARIANT.M2_GREEN_PREMIUM,e.isSenderReminderEnabled=ge,e.passStore=J,e.sharingInfoStore=Pe,e.title_bar_pass_ui_esnext=xe,e.useSeenStateInfo=(e,t,s)=>x.useQuery({apiArg:{file_infos:B(e,t),limit:s}})}));
//# sourceMappingURL=c_file_viewer_title_bar_title_bar_pass_ui.js-vflAl-RuZ.map

//# debugId=8b628ee6-251d-3e02-b8df-3ad631091fce