!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="76dcf201-c559-3bda-9d50-13ca5626528e")}catch(e){}}();
define(["require","exports","react","./e_file_viewer_static_scl_page_folder","./c_share_download_ui_api","./c_core_i18n","./c_ui_async_file_modal_controller","./c_api_v2_routes_folders_info_provider","./c_api_v2_routes_password_confirmation_provider","./e_core_exception","./c_encrypted_folder_ekms","./c_portable_save_as_copy","./c_portable_save_as_copy_snackbars","./c_admin_registration_source_constants","./c_file_viewer_common_show_auth_modal","./c_file_viewer_pap_logger_utils","./c_pap-events_docsend_view_docsend_hub_entry_button"],(function(e,o,t,n,r,i,a,s,l,d,c,_,u,p,g,f,w){"use strict";function h(e){return e&&e.__esModule?e:{default:e}}var m,y=h(t);function v(e){if("aes_256_gcm"===e[".tag"])return"AES256_GCM_EXTRAS";throw new Error("Could not convert EncryptionScheme to Algorithm")}function E(e){if(!e)throw new Error("Missing symmetric crypto extras");return{authTag:l.protoBase64.dec(e.auth_tag),nonce:l.protoBase64.dec(e.nonce)}}function b(e){if("blockwise"!==e[".tag"])throw new Error("Currently only blockwise encryption is supported");if(!e.block_encryption_extras)throw new Error("Missing block encryption extras");return{schemeType:{case:"blockwise",value:{setAuthTag:l.protoBase64.dec(e.set_auth_tag),blockEncryptionExtras:e.block_encryption_extras.map((e=>E(e))),encryptedHmacKey:l.protoBase64.dec(e.encrypted_hmac_key),hmacKeyEncryptionExtras:E(e.hmac_key_encryption_extras)}}}}!function(e){e.ClientNotEnrolled="client_not_enrolled",e.MissingFileEncryptionInfo="missing_file_encryption_info",e.CouldNotLoadClientKey="could_not_load_client_key",e.CouldNotLoadFileKey="could_not_load_file_key",e.KeyVerificationRequired="key_verification_required",e.InvalidTeamKeyFingerprint="invalid_team_key_fingerprint",e.MissingTeamKeyFingerprint="missing_team_key_fingerprint"}(m||(m={}));class k extends Error{constructor(e,o){super(),this.type=e,this.filesCount=o}}const M=e=>`/encrypted_folder_download/proxy?${new URLSearchParams({downloadUrl:e})}`,S=async e=>{var o;n.encryptedFolderMetrics.downloadHandleSingleFile();const{href:t,user:r,fileEncryptionInfo:i}=e;if(!n.isClientEnrolled({user:r})){if("key_verification_enabled"===n.getClientNotEnrolledReason(r))throw new k(m.KeyVerificationRequired,1);throw new k(m.ClientNotEnrolled,1)}const a=await(async()=>{const e=await navigator.serviceWorker.register("/encrypted_folder_download/service_worker.js",{scope:"/encrypted_folder_download/proxy"});return e.active?(n.encryptedFolderMetrics.serviceWorkerState(n.ServiceWorkerState.active),e.active):new Promise(((o,t)=>{const r=e.installing||e.waiting;if(!r){n.encryptedFolderMetrics.serviceWorkerState(n.ServiceWorkerState.hanging);const e=new Error("Service Worker: Failed to activate Encrypted Folder service worker");return d.reportException({err:e,tags:["encrypted_folder_web_service_worker"],severity:d.SEVERITY.CRITICAL}),void t(e)}const i=()=>{"activated"===r.state&&(n.encryptedFolderMetrics.serviceWorkerState(n.ServiceWorkerState.activated),r.removeEventListener("statechange",i),o(r))};r.addEventListener("statechange",i)}))})();if(!(i.keyid&&i.encryption_scheme&&i.content_encryption_extras&&i.per_revision_key_info))throw new k(m.MissingFileEncryptionInfo,1);let _,u;try{_=n.loadClientKey({user:r})}catch(e){throw n.encryptedFolderMetrics.ekmsLoadClientKeyFail(),new k(m.CouldNotLoadClientKey,1)}try{const e=n.loadTeamKeyFingerprint(r);u=(await c.loadFileKeys([i.keyid],_,e))[0]}catch(e){const t=n.filterApiError(e);if("root_key_not_found"===(null===(o=null==t?void 0:t.error)||void 0===o?void 0:o[".tag"])&&n.removeClientKey(r),e instanceof c.LocalError){if("missing_team_key_fingerprint"===e.tag)throw new k(m.MissingTeamKeyFingerprint,1);if("invalid_team_key_fingerprint"===e.tag)throw new k(m.InvalidTeamKeyFingerprint,1)}throw new k(m.CouldNotLoadFileKey,1)}var p;return((e,o)=>{e.postMessage(o),n.encryptedFolderMetrics.serviceWorkerMetadataPosted()})(a,[new URL(s.URI.parse(t).toString()).pathname,{fileKey:u,algorithm:v(i.encryption_scheme),contentEncryptionExtras:b(i.content_encryption_extras),perRevisionKeyInfo:(p=i.per_revision_key_info,{encryptedKeyData:l.protoBase64.dec(p.encrypted_key_data),encryptionExtras:l.protoBase64.dec(p.encryption_extras)}),encryptedPlaintextBlocklist:l.protoBase64.dec(i.encrypted_plaintext_blocklist),plaintextBlocklistEncryptionExtras:l.protoBase64.dec(i.plaintext_blocklist_encryption_extras)}]),M},T=async({href:e,source:o,isFswm:t=!1,user:s,fileEncryptionInfo:l,sharedFileTargetObjectMetadata:c,loggingParams:_},{onAttempt:u,onSuccess:p,onError:g}={})=>{null==u||u();const f=t?await r.fetchDownloadUrl({sharedLinkUrl:e,origin:n.SHARE_ACTION_ORIGIN_TYPE.PREVIEW_PAGE,userId:null==s?void 0:s.id,targetObjectMetadata:c}):e;let w;try{s&&l&&(w=await S({href:e,source:o,user:s,fileEncryptionInfo:l}))}catch(e){return e instanceof k?(d.reportException({err:e,tags:["encrypted_folder_web_download"],severity:d.SEVERITY.USER_ERROR}),await function(e){let o,t,n;switch(e.type){case m.KeyVerificationRequired:o=i.intl.formatMessage({id:"B9f72o",defaultMessage:"Can’t download encrypted files from dropbox.com"}),t=i.intl.formatMessage({id:"l7E3wZ",defaultMessage:"Instead, drag this file onto your desktop from the Dropbox desktop app to save a copy."}),n="https://help.dropbox.com/security/encrypted-team-folders";break;case m.ClientNotEnrolled:o=i.intl.formatMessage({id:"4VG05R",defaultMessage:"Can’t download {count, plural, one{file} other{files}} until your device is enrolled."},{count:e.filesCount}),t=i.intl.formatMessage({id:"mU5ADz",defaultMessage:"{count, plural, one{This file is} other{These files are}} encrypted but your client is not yet enrolled. Refresh the page and try to download again later."},{count:e.filesCount}),n="https://help.dropbox.com/security/encrypted-team-folders";break;case m.InvalidTeamKeyFingerprint:o=i.intl.formatMessage({id:"IViN4r",defaultMessage:"Team code mismatch"}),t=i.intl.formatMessage({id:"nLEaCJ",defaultMessage:"The team code changed since the device enrollment. Please clear your browser cache and re-register your browser."}),n="https://help.dropbox.com/security/encrypted-team-folders";break;case m.MissingTeamKeyFingerprint:o=i.intl.formatMessage({id:"jIzUTE",defaultMessage:"Team code missing"}),t=i.intl.formatMessage({id:"vaKHHG",defaultMessage:"Team code not found. Please clear your browser cache and re-register your browser."}),n="https://help.dropbox.com/security/encrypted-team-folders";break;default:o=i.intl.formatMessage({id:"jvEL5d",defaultMessage:"Unable to download encrypted {count, plural, one{file} other{files}}"},{count:e.filesCount}),t=i.intl.formatMessage({id:"m9vbqW",defaultMessage:"{count, plural, one{This file is} other{These files are}} encrypted but there was an error during decryption preparation. Refresh the page and try to download again later."},{count:e.filesCount}),n=""}return new Promise(((e,r)=>{a.showFileSystemWarningsModal({confirmText:i.intl.formatMessage({id:"SOYcjX",defaultMessage:"Got it"}),fsws:[{id:"action_download_encrypted",blocking:!0,title:o,text:t,learn_more:n}],onFinalAccept:e,onAbortAction:r})}))}(e)):d.reportException({err:e,tags:["encrypted_folder_web_download"],severity:d.SEVERITY.CRITICAL}),void(null==g||g())}n.get({url:f,source:`${o}_direct`,error:g,getProxyUrl:w,loggingParams:_}),null==p||p()};const P=["browse","shared_link_in_band","shared_link_out_of_band","shared_link_embed","version_history","home","hellosign","recents","starred","standalone_preview","collections","shared_collection","client_portal","transfer","file_locking","backup","video_synthesis","video_home","quick_view_browse","quick_view_search","desktop_preview","search","unknown_surface","photos","fss_desktop_preview","pollux_desktop_preview","edison_desktop_preview","pollux_desktop_search_preview","low_distraction_view","share_sender_preview"];function R(e){return P.find((o=>o===(null==e?void 0:e.toLowerCase())))}function I(e,o,t,r,i,a,s,l,d){if(r)if(o("save_to_dropbox"),t)_.portableSaveAsCopy({file:e,user:t,shareToken:r},{onNetworkRequest:()=>{u.saveCopySnackBarInProgress(n.PREVIEWS_SNACKBAR_ID),o("save_to_dropbox_approve")},onModalClose:()=>{o("save_to_dropbox_cancel")}},s);else{const e=new URL(window.location.href);e.searchParams.set("copy_to_dropbox","true"),window.history.replaceState(e.href,"",e.href),g.showAuthModal({mode:n.AuthMode.REGISTER,sharedLinkUrl:e.href,kind:n.LoginOrRegisterKind$1.DOWNLOAD,encryptionOptions:i,loggingExtra:{signup_source:"save_to_dropbox"},signupTag:a,webSignInTag:l,authDialogPreviousElement:n.AuthDialogPreviousElementTag.COPY_TO_DROPBOX,sharedLinkInfo:d})}}function D(o){const{file:t,user:r,encryptionOptions:i,authModalKind:a,logUserAction:s,shareToken:l,webSignInTag:d,isMobileWeb:c,userPresentableVerdict:_,userActionContext:u,previewSurface:p}=o;A(n.TiburonEventName.ClickDownload,t,null==r?void 0:r.id);if(C(r))return O(t,i,_);if(_===n.UserPresentableVerdict.SPEEDBUMP){return void U((()=>D({...o,userPresentableVerdict:void 0})),t)}const f="has_seen_download_signup_modal";if(a===n.LoginOrRegisterKind.DOWNLOAD&&!n.LocalStorage.get(f)&&(r||!c)){const o=(e,o)=>{if(n.LocalStorage.set(f,!0),o===n.Mode.REGISTER){const e=new URL(window.location.href);return e.searchParams.set("from_auth","register"),void window.location.assign(e.href)}},t=()=>{n.LocalStorage.set(f,!0)};return void new Promise((function(o,t){e(["./c_auth_login_or_register_modal"],o,t)})).then((({LoginOrRegisterModal:e})=>{n.Modal$1.showInstance(y.default.createElement(e,{downloadAction:n.DownloadAction.DIRECT_DOWNLOAD,id:"shared-link-download-signup-modal",initialMode:n.Mode.REGISTER,kind:a,onAuthenticateSuccess:o,onCancel:t,signup_tag:"shmodel_download_register",encryptionOptions:i,loggingExtra:{source:"download_button"},webSignInTag:d,authDialogPreviousElement:n.AuthDialogPreviousElementTag.DOWNLOAD}))}))}x(t,r,void 0,u,p);const w=(e,o,t,r,i,a,l,d)=>{g.showAuthModal({mode:o,kind:n.LoginOrRegisterKind$1.DOWNLOAD,encryptionOptions:i,loggingExtra:{signup_source:"post_download_modal"},webSignInTag:l,authDialogPreviousElement:d}),null==s||s(o===n.AuthMode.LOGIN?"post_download_signin_modal_login":"post_download_signin_modal_register","post_download_signin_modal")};r||n.showPostDownloadSignInModal({encryptionOptions:i,logUserAction:s,isFolder:!1,shareToken:l,linkUrl:t.href,handleClick:w})}const A=(e,o,t)=>{if(n.isSharedFile(o)){const r=n.parseLink(o.href);n.logEvent(e,o.file_id,void 0,t,r,n.SHARE_ACTION_ORIGIN_TYPE.SHARING_PREVIEW_PAGE)}},x=(e,o,t,r,i)=>{const a={onAttempt:()=>{var r;A(n.TiburonEventName.DownloadAttempt,e,null==o?void 0:o.id),null===(r=null==t?void 0:t.onAttempt)||void 0===r||r.call(t)},onSuccess:()=>{var r;A(n.TiburonEventName.DownloadSuccess,e,null==o?void 0:o.id),null===(r=null==t?void 0:t.onSuccess)||void 0===r||r.call(t)},onError:()=>{var r;A(n.TiburonEventName.DownloadFail,e,null==o?void 0:o.id),null===(r=null==t?void 0:t.onError)||void 0===r||r.call(t)}};T({href:e.href,source:"PREVIEWS",isFswm:n.isSharedFile(e),user:o,fileEncryptionInfo:n.getFileEncryptionInfo(e),sharedFileTargetObjectMetadata:n.isSharedFile(e)?n.getTargetObjectMetadataFromEntry(e):void 0,loggingParams:{actionSurface:"previews",actionElement:r,fileSize:e.bytes,fileType:n.getFileTypeFromString(n.getExtension$1(e)),previewType:f.getPapPreviewType(n.resolvePreviewType(e.preview,n.getFilename(e))),previousSurface:i?R(i):void 0}},a)},C=e=>!w.is_mobile_or_tablet()&&!e,O=(o,t,r)=>{Promise.all([new Promise((function(o,t){e(["./c_auth_login_or_register_modal"],o,t)})),new Promise((function(o,t){e(["./c_google_one_tap_google_one_tap_platform"],o,t)})).then((function(e){return e.google_one_tap_platform_esnext})),new Promise((function(o,t){e(["./c_features_download_index"],o,t)}))]).then((([{LoginOrRegisterModal:e},{GoogleOneTapPlatform:i},{PreDownloadSUSIModalFooter:a}])=>{A(n.TiburonEventName.ViewSUSIDownloadModal,o);const s=window.location.href,l=new URL(s);l.searchParams.set("download","true");const d=new URL(l);d.searchParams.set("from_auth","register");const c=new URL(l);c.searchParams.set("from_auth","login"),i.updateLoginContUrl(c.href);n.Modal$1.showInstance(y.default.createElement(e,{downloadAction:n.DownloadAction.DIRECT_DOWNLOAD,isFolderAction:!1,id:"shared-link-download-signup-modal",initialMode:n.Mode.REGISTER,kind:n.LoginOrRegisterKind.DOWNLOAD_PROMPT,signup_tag:p.RegistrationSource.PREVIEW_DOWNLOAD_PROMPT,encryptionOptions:t,loggingExtra:{source:"download_button"},webSignInTag:p.RegistrationSource.PREVIEW_DOWNLOAD_PROMPT,customFooterContent:()=>y.default.createElement(a,{onEscapeHatchClick:()=>{i.updateLoginContUrl(s),A(n.TiburonEventName.ContinueWithDownloadOnly,o),n.Modal$1.close();F(o,!1,void 0,r)}}),onCancel:()=>{i.updateLoginContUrl(s),A(n.TiburonEventName.CloseSUSIDownloadModal,o)},loginContinuationUrl:c.href,registrationContinuationUrl:d.href,postUpsellRedirectUrl:d.href,canRedirect:!0,authDialogPreviousElement:n.AuthDialogPreviousElementTag.DOWNLOAD}))}))},F=(e,o=!1,t,r)=>{r!==n.UserPresentableVerdict.SPEEDBUMP?(o&&t?L(e,t):N(),x(e,t)):U((()=>F(e,o,t,void 0)),e)},L=(o,t)=>{new Promise((function(o,t){e(["./c_features_download_index"],o,t)})).then((({PostSignupDownloadModal:e})=>{A(n.TiburonEventName.ViewPostSignupDownloadModal,o,t.id);const r="post-signup-download-modal";n.Modal$1.showInstance(y.default.createElement(e,{open:!0,onClose:()=>{A(n.TiburonEventName.ClosePostSignupDownloadModal,o,t.id),n.Modal$1.close(void 0,r)}}),void 0,r)}))},N=()=>{n.Snackbar.show(y.default.createElement(n.Snackbar,{id:"post-download-snackbar",title:i.intl.formatMessage({id:"0EIDZ+",defaultMessage:"Your download should start soon. If it doesn’t, go back to try again."}),closeButtonText:i.intl.formatMessage({id:"RfGyPH",defaultMessage:"Close"})}))},U=(o,t)=>{new Promise((function(o,t){e(["./c_features_download_index"],o,t)})).then((({DownloadWarningModal:e})=>{n.Modal$1.showInstance(y.default.createElement(e,{continueDownload:o,fileName:n.getFilename(t)}))}))};var W=Object.freeze({__proto__:null,downloadActiveFile:D,initiateDownload:x,logSharingTiburonEvent:A,postAuthSuccessAndDownload:F,saveToDropbox:I,showDownloadWarningModal:U});o.downloadActiveFile=D,o.downloadSingleFile=T,o.downloadSingleFileAsZip=async({fqPath:e,rootNsId:o,source:t,blockHash:r,user:i,loggingParams:a},{onAttempt:s,onSuccess:l}={})=>{null==s||s(),n.get_zip({userApiProps:i,fq_paths:[e],block_hash:r,parent_path:n.parent_dir(e),source:t,root_ns_id:o,loggingParams:a}),null==l||l()},o.download_utils_esnext=W,o.getPreviousSurfaceFromString=R,o.saveToDropbox=I}));
//# sourceMappingURL=c_file_viewer_common_download_utils.js-vflQFT4g2.map

//# debugId=76dcf201-c559-3bda-9d50-13ca5626528e